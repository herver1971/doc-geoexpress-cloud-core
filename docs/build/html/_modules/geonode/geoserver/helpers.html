

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geonode.geoserver.helpers &mdash; GeoNode Cloud Core 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            GeoNode Cloud Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">GeoNode Cloud Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../geonode.html">geonode</a></li>
          <li class="breadcrumb-item"><a href="../geoserver.html">geonode.geoserver</a></li>
      <li class="breadcrumb-item active">geonode.geoserver.helpers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geonode.geoserver.helpers</h1><div class="highlight"><pre>
<span></span><span class="c1">#########################################################################</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2016 OSGeo</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">#########################################################################</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>

<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">urljoin</span>
<span class="kn">from</span> <span class="nn">pinax.ratings.models</span> <span class="kn">import</span> <span class="n">OverallRating</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">import_string</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">geoserver.catalog</span> <span class="kn">import</span> <span class="n">Catalog</span><span class="p">,</span> <span class="n">FailedRequestError</span>
<span class="kn">from</span> <span class="nn">geoserver.resource</span> <span class="kn">import</span> <span class="n">FeatureType</span><span class="p">,</span> <span class="n">Coverage</span>
<span class="kn">from</span> <span class="nn">geoserver.store</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CoverageStore</span><span class="p">,</span>
    <span class="n">DataStore</span><span class="p">,</span>
    <span class="n">datastore_from_index</span><span class="p">,</span>
    <span class="n">coveragestore_from_index</span><span class="p">,</span>
    <span class="n">wmsstore_from_index</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">geoserver.support</span> <span class="kn">import</span> <span class="n">DimensionInfo</span>
<span class="kn">from</span> <span class="nn">geoserver.workspace</span> <span class="kn">import</span> <span class="n">Workspace</span>
<span class="kn">from</span> <span class="nn">gsimporter</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span><span class="p">,</span> <span class="n">objectify</span>
<span class="kn">from</span> <span class="nn">owslib.etree</span> <span class="kn">import</span> <span class="n">etree</span> <span class="k">as</span> <span class="n">dlxml</span>
<span class="kn">from</span> <span class="nn">owslib.wcs</span> <span class="kn">import</span> <span class="n">WebCoverageService</span>

<span class="kn">from</span> <span class="nn">geonode</span> <span class="kn">import</span> <span class="n">GeoNodeException</span>
<span class="kn">from</span> <span class="nn">geonode.base.models</span> <span class="kn">import</span> <span class="n">Link</span>
<span class="kn">from</span> <span class="nn">geonode.base.models</span> <span class="kn">import</span> <span class="n">ResourceBase</span>
<span class="kn">from</span> <span class="nn">geonode.security.views</span> <span class="kn">import</span> <span class="n">_perms_info_json</span>
<span class="kn">from</span> <span class="nn">geonode.catalogue.models</span> <span class="kn">import</span> <span class="n">catalogue_post_save</span>
<span class="kn">from</span> <span class="nn">geonode.layers.models</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">Style</span>
<span class="kn">from</span> <span class="nn">geonode.layers.enumerations</span> <span class="kn">import</span> <span class="n">LAYER_ATTRIBUTE_NUMERIC_DATA_TYPES</span>

<span class="kn">from</span> <span class="nn">geonode.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OGC_Servers_Handler</span><span class="p">,</span>
    <span class="n">http_client</span><span class="p">,</span>
    <span class="n">get_legend_url</span><span class="p">,</span>
    <span class="n">is_monochromatic_image</span><span class="p">,</span>
    <span class="n">set_resource_default_links</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.acl.acl_client</span> <span class="kn">import</span> <span class="n">AclClient</span><span class="p">,</span> <span class="n">AclUtils</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


<div class="viewcode-block" id="temp_style_name_regex">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.temp_style_name_regex">[docs]</a>
<span class="n">temp_style_name_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[a-zA-Z0-9]</span><span class="si">{8}</span><span class="s2">-[a-zA-Z0-9]</span><span class="si">{4}</span><span class="s2">-[a-zA-Z0-9]</span><span class="si">{4}</span><span class="s2">-[a-zA-Z0-9]</span><span class="si">{4}</span><span class="s2">-[a-zA-Z0-9]</span><span class="si">{12}</span><span class="s2">_ms_.*&quot;</span></div>


<div class="viewcode-block" id="LAYER_SUBTYPES">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.LAYER_SUBTYPES">[docs]</a>
<span class="n">LAYER_SUBTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dataStore&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coverageStore&quot;</span><span class="p">:</span> <span class="s2">&quot;raster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;remoteStore&quot;</span><span class="p">:</span> <span class="s2">&quot;remote&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vectorTimeSeries&quot;</span><span class="p">:</span> <span class="s2">&quot;vector_time&quot;</span><span class="p">,</span>
<span class="p">}</span></div>


<div class="viewcode-block" id="WPS_ACCEPTABLE_FORMATS">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.WPS_ACCEPTABLE_FORMATS">[docs]</a>
<span class="n">WPS_ACCEPTABLE_FORMATS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;application/arcgrid&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;image/tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;application/wfs-collection-1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;application/wfs-collection-1.1&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;application/zip&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">),</span>
<span class="p">]</span></div>


<div class="viewcode-block" id="DEFAULT_STYLE_NAME">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.DEFAULT_STYLE_NAME">[docs]</a>
<span class="n">DEFAULT_STYLE_NAME</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;generic&quot;</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">]</span></div>



<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;OGC_SERVER&quot;</span><span class="p">):</span>
<div class="viewcode-block" id="msg">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.msg">[docs]</a>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Please configure OGC_SERVER when enabling geonode.geoserver.&quot;</span>
        <span class="s2">&quot; More info can be found at &quot;</span>
        <span class="s2">&quot;http://docs.geonode.org/en/2.10.x/basic/settings/index.html#ogc-server&quot;</span>
    <span class="p">)</span></div>

    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="check_geoserver_is_up">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.check_geoserver_is_up">[docs]</a>
<span class="k">def</span> <span class="nf">check_geoserver_is_up</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verifies all geoserver is running,</span>
<span class="sd">    this is needed to be able to upload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot connect to the GeoServer at </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">Please make sure you have started it.&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="n">msg</span></div>



<div class="viewcode-block" id="_add_sld_boilerplate">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._add_sld_boilerplate">[docs]</a>
<span class="k">def</span> <span class="nf">_add_sld_boilerplate</span><span class="p">(</span><span class="n">symbolizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap an XML snippet representing a single symbolizer in the appropriate</span>
<span class="sd">    elements to make it a valid SLD which applies that symbolizer to all features,</span>
<span class="sd">    including format strings to allow interpolating a &quot;name&quot; variable in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;StyledLayerDescriptor version=&quot;1.0.0&quot; xmlns=&quot;http://www.opengis.net/sld&quot; xmlns:ogc=&quot;http://www.opengis.net/ogc&quot;</span>
<span class="sd">  xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="sd">  xsi:schemaLocation=&quot;http://www.opengis.net/sld http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd&quot;&gt;</span>
<span class="sd">  &lt;NamedLayer&gt;</span>
<span class="sd">    &lt;Name&gt;%(name)s&lt;/Name&gt;</span>
<span class="sd">    &lt;UserStyle&gt;</span>
<span class="sd">    &lt;Name&gt;%(name)s&lt;/Name&gt;</span>
<span class="sd">    &lt;Title&gt;%(name)s&lt;/Title&gt;</span>
<span class="sd">      &lt;FeatureTypeStyle&gt;</span>
<span class="sd">        &lt;Rule&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="o">+</span> <span class="n">symbolizer</span>
        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;/Rule&gt;</span>
<span class="s2">      &lt;/FeatureTypeStyle&gt;</span>
<span class="s2">    &lt;/UserStyle&gt;</span>
<span class="s2">  &lt;/NamedLayer&gt;</span>
<span class="s2">&lt;/StyledLayerDescriptor&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_raster_template">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._raster_template">[docs]</a>
<span class="n">_raster_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;RasterSymbolizer&gt;</span>
<span class="s2">    &lt;Opacity&gt;1.0&lt;/Opacity&gt;</span>
<span class="s2">&lt;/RasterSymbolizer&gt;</span>
<span class="s2">&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="_polygon_template">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._polygon_template">[docs]</a>
<span class="n">_polygon_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;PolygonSymbolizer&gt;</span>
<span class="s2">  &lt;Fill&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;fill&quot;&gt;</span><span class="si">%(bg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">  &lt;/Fill&gt;</span>
<span class="s2">  &lt;Stroke&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;stroke&quot;&gt;</span><span class="si">%(fg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;stroke-width&quot;&gt;0.7&lt;/CssParameter&gt;</span>
<span class="s2">  &lt;/Stroke&gt;</span>
<span class="s2">&lt;/PolygonSymbolizer&gt;</span>
<span class="s2">&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="_line_template">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._line_template">[docs]</a>
<span class="n">_line_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;LineSymbolizer&gt;</span>
<span class="s2">  &lt;Stroke&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;stroke&quot;&gt;</span><span class="si">%(bg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;stroke-width&quot;&gt;3&lt;/CssParameter&gt;</span>
<span class="s2">  &lt;/Stroke&gt;</span>
<span class="s2">&lt;/LineSymbolizer&gt;</span>
<span class="s2">&lt;/Rule&gt;</span>
<span class="s2">&lt;/FeatureTypeStyle&gt;</span>
<span class="s2">&lt;FeatureTypeStyle&gt;</span>
<span class="s2">&lt;Rule&gt;</span>
<span class="s2">&lt;LineSymbolizer&gt;</span>
<span class="s2">  &lt;Stroke&gt;</span>
<span class="s2">    &lt;CssParameter name=&quot;stroke&quot;&gt;</span><span class="si">%(fg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">  &lt;/Stroke&gt;</span>
<span class="s2">&lt;/LineSymbolizer&gt;</span>
<span class="s2">&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="_point_template">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._point_template">[docs]</a>
<span class="n">_point_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;PointSymbolizer&gt;</span>
<span class="s2">  &lt;Graphic&gt;</span>
<span class="s2">    &lt;Mark&gt;</span>
<span class="s2">      &lt;WellKnownName&gt;</span><span class="si">%(mark)s</span><span class="s2">&lt;/WellKnownName&gt;</span>
<span class="s2">      &lt;Fill&gt;</span>
<span class="s2">        &lt;CssParameter name=&quot;fill&quot;&gt;</span><span class="si">%(bg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">      &lt;/Fill&gt;</span>
<span class="s2">      &lt;Stroke&gt;</span>
<span class="s2">        &lt;CssParameter name=&quot;stroke&quot;&gt;</span><span class="si">%(fg)s</span><span class="s2">&lt;/CssParameter&gt;</span>
<span class="s2">      &lt;/Stroke&gt;</span>
<span class="s2">    &lt;/Mark&gt;</span>
<span class="s2">    &lt;Size&gt;10&lt;/Size&gt;</span>
<span class="s2">  &lt;/Graphic&gt;</span>
<span class="s2">&lt;/PointSymbolizer&gt;</span>
<span class="s2">&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="_style_templates">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._style_templates">[docs]</a>
<span class="n">_style_templates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">raster</span><span class="o">=</span><span class="n">_add_sld_boilerplate</span><span class="p">(</span><span class="n">_raster_template</span><span class="p">),</span>
    <span class="n">polygon</span><span class="o">=</span><span class="n">_add_sld_boilerplate</span><span class="p">(</span><span class="n">_polygon_template</span><span class="p">),</span>
    <span class="n">line</span><span class="o">=</span><span class="n">_add_sld_boilerplate</span><span class="p">(</span><span class="n">_line_template</span><span class="p">),</span>
    <span class="n">point</span><span class="o">=</span><span class="n">_add_sld_boilerplate</span><span class="p">(</span><span class="n">_point_template</span><span class="p">),</span>
<span class="p">)</span></div>


<div class="viewcode-block" id="STYLES_VERSION">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.STYLES_VERSION">[docs]</a>
<span class="n">STYLES_VERSION</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">:</span> <span class="s2">&quot;sld10&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1.0&quot;</span><span class="p">:</span> <span class="s2">&quot;sld11&quot;</span><span class="p">}</span></div>



<div class="viewcode-block" id="_extract_style_version_from_sld">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._extract_style_version_from_sld">[docs]</a>
<span class="k">def</span> <span class="nf">_extract_style_version_from_sld</span><span class="p">(</span><span class="n">sld</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assume: SLD as a byte</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">objectify</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">sld</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">STYLES_VERSION</span><span class="p">[</span><span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">STYLES_VERSION</span><span class="p">[</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="_style_name">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._style_name">[docs]</a>
<span class="k">def</span> <span class="nf">_style_name</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_punc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_name_from_sld">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.extract_name_from_sld">[docs]</a>
<span class="k">def</span> <span class="nf">extract_name_from_sld</span><span class="p">(</span><span class="n">gs_catalog</span><span class="p">,</span> <span class="n">sld</span><span class="p">,</span> <span class="n">sld_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sld</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">sld</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sld_file</span><span class="p">:</span>
                    <span class="n">sld</span> <span class="o">=</span> <span class="n">sld_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">sld</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XML</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">resolve_entities</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">sld_file</span> <span class="ow">and</span> <span class="n">isfile</span><span class="p">(</span><span class="n">sld_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sld_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sld_file</span><span class="p">:</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">sld_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">sld</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sld</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;The uploaded SLD file is not valid XML&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The uploaded SLD file is not valid XML&quot;</span><span class="p">)</span>

    <span class="n">named_dataset</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}NamedLayer&quot;</span><span class="p">)</span>
    <span class="n">user_dataset</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}UserLayer&quot;</span><span class="p">)</span>

    <span class="n">el</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">named_dataset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">named_dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">user_style</span> <span class="o">=</span> <span class="n">named_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}UserStyle&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_style</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_style</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">user_style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}Name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">user_style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/se}Name&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">named_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}Name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">named_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/se}Name&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_dataset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">user_style</span> <span class="o">=</span> <span class="n">user_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}UserStyle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_style</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_style</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">user_style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}Name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">el</span> <span class="o">=</span> <span class="n">user_style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/se}Name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">user_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/sld}Name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">user_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;{http://www.opengis.net/se}Name&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sld_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">sld_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please provide a name, unable to extract one from the SLD.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span></div>



<div class="viewcode-block" id="get_sld_for">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_sld_for">[docs]</a>
<span class="k">def</span> <span class="nf">get_sld_for</span><span class="p">(</span><span class="n">gs_catalog</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gs_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gs_style</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_default_style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_max_retries</span><span class="p">,</span> <span class="n">_tries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ogc_server_settings</span><span class="p">,</span> <span class="s2">&quot;MAX_RETRIES&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="p">:</span>
            <span class="n">gs_style</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">sld_body</span>
            <span class="n">set_dataset_style</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span> <span class="n">gs_style</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span>
        <span class="n">_default_style</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">_tries</span> <span class="o">&lt;</span> <span class="n">_max_retries</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gs_dataset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="p">:</span>
                    <span class="n">gs_style</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">sld_body</span>
                    <span class="n">set_dataset_style</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span> <span class="n">gs_style</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_default_style</span><span class="p">:</span>
        <span class="n">_default_style</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_default_style</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">_default_style</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">gs_style</span> <span class="o">=</span> <span class="n">_default_style</span><span class="o">.</span><span class="n">sld_body</span> <span class="k">if</span> <span class="n">_default_style</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            GeoServer didn&#39;t return a default style for this layer.</span>
<span class="s2">            Consider increasing OGC_SERVER MAX_RETRIES value.&#39;&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Detect geometry type if it is a FeatureType</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">resource</span> <span class="k">if</span> <span class="n">gs_dataset</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="s2">&quot;featureType&quot;</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ft</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">):</span>
            <span class="n">attr_binding</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;binding&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;jts.geom&quot;</span> <span class="ow">in</span> <span class="n">attr_binding</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Polygon&quot;</span> <span class="ow">in</span> <span class="n">attr_binding</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;Line&quot;</span> <span class="ow">in</span> <span class="n">attr_binding</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span>

    <span class="c1"># FIXME: When gsconfig.py exposes the default geometry type for vector</span>
    <span class="c1"># layers we should use that rather than guessing based on the auto-detected</span>
    <span class="c1"># style.</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_style_templates</span><span class="p">:</span>
        <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">mark</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_style_contexts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_style_templates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gs_style</span></div>



<div class="viewcode-block" id="set_dataset_style">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_dataset_style">[docs]</a>
<span class="k">def</span> <span class="nf">set_dataset_style</span><span class="p">(</span><span class="n">saved_dataset</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">sld</span><span class="p">,</span> <span class="n">base_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check SLD is valid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sld</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">sld</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sld_file</span><span class="p">:</span>
                    <span class="n">sld</span> <span class="o">=</span> <span class="n">sld_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">sld</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;b&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">r)|(</span><span class="se">\\</span><span class="s2">n)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sld</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
            <span class="n">etree</span><span class="o">.</span><span class="n">XML</span><span class="p">(</span><span class="n">sld</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">resolve_entities</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">base_file</span> <span class="ow">and</span> <span class="n">isfile</span><span class="p">(</span><span class="n">base_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">base_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sld_file</span><span class="p">:</span>
                <span class="n">sld</span> <span class="o">=</span> <span class="n">sld_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">dlxml</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">base_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;The uploaded SLD file is not valid XML&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The uploaded SLD file is not valid XML&quot;</span><span class="p">)</span>

    <span class="c1"># Check Dataset&#39;s available styles</span>
    <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">style</span> <span class="ow">and</span> <span class="n">style</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">style</span>
            <span class="k">break</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span> <span class="ow">or</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span>
                <span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">style</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">create_style</span><span class="p">(</span>
                    <span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sld</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">workspace</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_sld_format</span> <span class="o">=</span> <span class="n">_extract_style_version_from_sld</span><span class="p">(</span><span class="n">sld</span><span class="p">)</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">create_style</span><span class="p">(</span>
                <span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">sld</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">style_format</span><span class="o">=</span><span class="n">_sld_format</span><span class="p">,</span>
                <span class="n">workspace</span><span class="o">=</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">and</span> <span class="n">style</span><span class="p">:</span>
        <span class="n">_old_styles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_old_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">_old_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">workspace</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">_old_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">_old_styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span> <span class="o">=</span> <span class="n">style</span>
        <span class="n">gs_catalog</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_s</span> <span class="ow">in</span> <span class="n">_old_styles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gs_catalog</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
                <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">resource</span><span class="o">=</span><span class="n">saved_dataset</span><span class="o">.</span><span class="n">resourcebase_ptr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span> <span class="n">url__contains</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;STYLE=</span><span class="si">{</span><span class="n">_s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">set_styles</span><span class="p">(</span><span class="n">saved_dataset</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">)</span></div>



<div class="viewcode-block" id="cascading_delete">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.cascading_delete">[docs]</a>
<span class="k">def</span> <span class="nf">cascading_delete</span><span class="p">(</span><span class="n">dataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_name</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">catalog</span> <span class="ow">or</span> <span class="n">gs_catalog</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">workspace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">workspace</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_workspace</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
            <span class="n">store</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">DATASTORE</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                            <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;the store was not found in geoserver&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;the store was not found in geoserver&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cascading delete was called on a layer where the workspace was not found&quot;</span><span class="p">)</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Could not connect to geoserver at &quot;</span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;to save information for layer &quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Let&#39;s reset the connections first</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If there is no associated resource,</span>
        <span class="c1"># this method can not delete anything.</span>
        <span class="c1"># Let&#39;s return and make a note in the log.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cascading_delete was called with a non existent resource&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">name</span>
    <span class="n">lyr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lyr</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lyr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Already deleted</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">store</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="n">lyr</span><span class="o">.</span><span class="n">styles</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="o">+</span> <span class="p">[</span><span class="n">lyr</span><span class="o">.</span><span class="n">default_style</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">workspace</span><span class="p">:</span>
            <span class="n">gs_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_styles</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])]</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="o">+</span> <span class="n">gs_styles</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_WORKSPACE</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_WORKSPACE</span> <span class="o">!=</span> <span class="n">workspace</span><span class="p">:</span>
            <span class="n">gs_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_styles</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_WORKSPACE</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])]</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="o">+</span> <span class="n">gs_styles</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">lyr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_default_style_names</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to delete Style [</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Trying to delete a shared style will fail</span>
                    <span class="c1"># We&#39;ll catch the exception and log it.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># Due to a possible bug of geoserver, we need this trick for now</span>
        <span class="c1"># TODO: inspect the issue reported by this hack. Should be solved</span>
        <span class="c1">#       with GS 2.7+</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># This may fail</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">store</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="s2">&quot;dataStore&quot;</span>
            <span class="ow">and</span> <span class="s2">&quot;dbtype&quot;</span> <span class="ow">in</span> <span class="n">store</span><span class="o">.</span><span class="n">connection_parameters</span>
            <span class="ow">and</span> <span class="n">store</span><span class="o">.</span><span class="n">connection_parameters</span><span class="p">[</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postgis&quot;</span>
        <span class="p">):</span>
            <span class="n">delete_from_postgis</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># AF: for the time being this one mitigates the issue #8671</span>
            <span class="c1"># until we find a suitable solution for the GeoTools ImageMosaic plugin</span>
            <span class="c1"># ref: https://github.com/geotools/geotools/blob/main/modules/plugin/imagemosaic/src/main/java/org/geotools/gce/imagemosaic/catalog/AbstractGTDataStoreGranuleCatalog.java#L753</span>
            <span class="k">if</span> <span class="n">store</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="s2">&quot;coverageStore&quot;</span> <span class="ow">and</span> <span class="n">store</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;ImageMosaic&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Going to purge the </span><span class="si">{</span><span class="n">store</span><span class="o">.</span><span class="n">resource_type</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">store</span><span class="o">.</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">cat</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># this resets the coverage readers and unlocks the files</span>
                    <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># cat.reload()  # this preservers the integrity of geoserver</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Trying to recursively purge a store may fail</span>
                    <span class="c1"># We&#39;ll catch the exception and log it.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">store</span><span class="o">.</span><span class="n">get_resources</span><span class="p">():</span>
                        <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Catch the exception and log it.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_from_postgis">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.delete_from_postgis">[docs]</a>
<span class="k">def</span> <span class="nf">delete_from_postgis</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a table from PostGIS (because Geoserver won&#39;t do it yet);</span>
<span class="sd">    to be used after deleting a layer from the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">psycopg2</span>

    <span class="c1"># we will assume that store/database may change (when using shard for example)</span>
    <span class="c1"># but user and password are the ones from settings (DATASTORE_URL)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">datastore_db</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">connection_parameters</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;USER&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">]</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">connection_parameters</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">connection_parameters</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT DropGeometryTable (&#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error deleting PostGIS table </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error closing PostGIS conn </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>



<div class="viewcode-block" id="gs_slurp">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.gs_slurp">[docs]</a>
<span class="k">def</span> <span class="nf">gs_slurp</span><span class="p">(</span>
    <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">console</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">skip_unadvertised</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_geonode_registered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">remove_deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">execute_signals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure the layers available in GeoServer in GeoNode.</span>
<span class="sd">    It returns a list of dictionaries with the name of the layer,</span>
<span class="sd">    the result of the operation and the errors and traceback if it failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">geonode.resource.manager</span> <span class="kn">import</span> <span class="n">resource_manager</span>

    <span class="k">if</span> <span class="n">console</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">console</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inspecting the available layers in GeoServer ...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">console</span><span class="p">)</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>

    <span class="k">if</span> <span class="n">workspace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">workspace</span><span class="p">:</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_workspace</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># obtain the store from within the workspace. if it exists, obtain resources</span>
            <span class="c1"># directly from store, otherwise return an empty list:</span>
            <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">resources</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resources</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">store</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">workspaces</span><span class="o">=</span><span class="p">[</span><span class="n">workspace</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">store</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">remove_deleted</span><span class="p">:</span>
        <span class="n">resources_for_delete_compare</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[:]</span>
        <span class="n">workspace_for_delete_compare</span> <span class="o">=</span> <span class="n">workspace</span>
        <span class="c1"># filter out layers for delete comparison with GeoNode layers by following criteria:</span>
        <span class="c1"># enabled = true, if --skip-unadvertised: advertised = true, but</span>
        <span class="c1"># disregard the filter parameter in the case of deleting layers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resources_for_delete_compare</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources_for_delete_compare</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">}]</span>
            <span class="k">if</span> <span class="n">skip_unadvertised</span><span class="p">:</span>
                <span class="n">resources_for_delete_compare</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources_for_delete_compare</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">advertised</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">}</span>
                <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span> <span class="k">if</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># filter out layers depending on enabled, advertised status:</span>
    <span class="n">_resources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">}:</span>
                <span class="n">_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="c1"># resources = [k for k in resources if k.enabled in {&quot;true&quot;, True}]</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="n">_resources</span>
    <span class="k">if</span> <span class="n">skip_unadvertised</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">advertised</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">}]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="c1"># filter out layers already registered in geonode</span>
    <span class="n">dataset_names</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skip_geonode_registered</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resources</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_names</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="c1"># TODO: Should we do something with these?</span>
    <span class="c1"># i.e. look for matching layers in GeoNode and also disable?</span>
    <span class="c1"># disabled_resources = [k for k in resources if k.enabled == &quot;false&quot;]</span>

    <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> layers, starting processing&quot;</span> <span class="o">%</span> <span class="n">number</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">console</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;deleted_datasets&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">resource</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resources</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">name</span>
        <span class="n">the_store</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">store</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">the_store</span><span class="o">.</span><span class="n">workspace</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="p">:</span>
                <span class="n">layer</span> <span class="o">=</span> <span class="n">resource_manager</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="n">Dataset</span><span class="p">,</span>
                    <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">store</span><span class="o">=</span><span class="n">the_store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">subtype</span><span class="o">=</span><span class="n">get_dataset_storetype</span><span class="p">(</span><span class="n">the_store</span><span class="o">.</span><span class="n">resource_type</span><span class="p">),</span>
                        <span class="n">alternate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No title provided&quot;</span><span class="p">),</span>
                        <span class="n">abstract</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No abstract provided&quot;</span><span class="p">),</span>
                        <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Hide the resource until finished</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set_processing_state</span><span class="p">(</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">)</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">native_bbox</span>
            <span class="n">ll_bbox</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">latlon_bbox</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">set_bbox_polygon</span><span class="p">([</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">resource</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">GeoNodeException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ll_bbox</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">srid</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set_ll_bbox_polygon</span><span class="p">([</span><span class="n">ll_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

            <span class="c1"># sync permissions in ACL</span>
            <span class="n">perm_spec</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">_perms_info_json</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
            <span class="n">resource_manager</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">perm_spec</span><span class="p">)</span>

            <span class="c1"># recalculate the layer statistics</span>
            <span class="n">set_attributes_from_geoserver</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># in some cases we need to explicitily save the resource to execute the signals</span>
            <span class="c1"># (for sure when running updatelayers)</span>
            <span class="n">resource_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">execute_signals</span><span class="p">)</span>

            <span class="c1"># Creating the Thumbnail</span>
            <span class="n">resource_manager</span><span class="o">.</span><span class="n">set_thumbnail</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_bbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Hide the resource until finished</span>
            <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">set_processing_state</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                <span class="n">exception_type</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Stopping process because --ignore-errors was not set and an error was found.&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
                <span class="n">exception_type</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Stopping process because --ignore-errors was not set and an error was found.&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>

                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
                <span class="n">output</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;created&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span>
                <span class="n">output</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] Dataset </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;traceback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">traceback</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exception_type</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">console</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remove_deleted</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">workspace_for_delete_compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workspace_for_delete_compare</span><span class="p">,</span> <span class="n">Workspace</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workspace__exact</span><span class="o">=</span><span class="n">workspace_for_delete_compare</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">workspace__exact</span><span class="o">=</span><span class="n">workspace_for_delete_compare</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">CoverageStore</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">DataStore</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">store__exact</span><span class="o">=</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">store__exact</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing &#39;remove_deleted&#39; logic&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;GeoNode Layers Found:&quot;</span><span class="p">)</span>

        <span class="c1"># compare the list of GeoNode layers obtained via query/filter with valid resources found in GeoServer</span>
        <span class="c1"># filtered per options passed to updatelayers: --workspace, --store, --skip-unadvertised</span>
        <span class="c1"># add any layers not found in GeoServer to deleted_datasets (must match</span>
        <span class="c1"># workspace and store as well):</span>
        <span class="n">deleted_datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;GeoNode Dataset info: name: </span><span class="si">%s</span><span class="s2">, workspace: </span><span class="si">%s</span><span class="s2">, store: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">store</span>
            <span class="p">)</span>
            <span class="n">dataset_found_in_geoserver</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources_for_delete_compare</span><span class="p">:</span>
                <span class="c1"># if layer.name matches a GeoServer resource, check also that</span>
                <span class="c1"># workspace and store match, mark valid:</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">workspace</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">store</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Matches GeoServer layer: name: </span><span class="si">%s</span><span class="s2">, workspace: </span><span class="si">%s</span><span class="s2">, store: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">resource</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">dataset_found_in_geoserver</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_found_in_geoserver</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;----- Dataset </span><span class="si">%s</span><span class="s2"> not matched, marked for deletion ---------------&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">deleted_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="n">number_deleted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">deleted_datasets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">%d</span><span class="s2"> layers to delete, starting processing&quot;</span> <span class="o">%</span> <span class="n">number_deleted</span>
                <span class="k">if</span> <span class="n">number_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">%d</span><span class="s2"> layers to delete&quot;</span> <span class="o">%</span> <span class="n">number_deleted</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">console</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deleted_datasets</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;GeoNode Dataset to delete: name: </span><span class="si">%s</span><span class="s2">, workspace: </span><span class="si">%s</span><span class="s2">, store: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">store</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># delete ratings, and taggit tags:</span>
                <span class="n">ct</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">OverallRating</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">ct</span><span class="p">,</span> <span class="n">object_id</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="n">layer</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">output</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;deleted&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;delete_succeeded&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;delete_failed&quot;</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] Dataset </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_deleted</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;delete_failed&quot;</span><span class="p">:</span>
                <span class="n">exception_type</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;traceback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">traceback</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exception_type</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;deleted_datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">console</span><span class="p">)</span>

    <span class="n">finish</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
    <span class="n">td</span> <span class="o">=</span> <span class="n">finish</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="s2">&quot;duration_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="get_stores">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_stores">[docs]</a>
<span class="k">def</span> <span class="nf">get_stores</span><span class="p">(</span><span class="n">store_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">stores</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_stores</span><span class="p">()</span>
    <span class="n">store_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
        <span class="n">store</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="n">stype</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">store_type</span> <span class="ow">and</span> <span class="n">store_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">stype</span><span class="p">:</span>
            <span class="n">store_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">stype</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">store_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">store_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">stype</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">store_list</span></div>



<div class="viewcode-block" id="set_attributes">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_attributes">[docs]</a>
<span class="k">def</span> <span class="nf">set_attributes</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute_map</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">attribute_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters:</span>

<span class="sd">    - *layer*: A `geonode.layers.models.Dataset` instance representing the dataset layer.</span>

<span class="sd">    - *attribute_map*: A list of 2-item lists specifying attribute names and types.</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            attribute_map = [</span>
<span class="sd">                [&#39;id&#39;, &#39;Integer&#39;],</span>
<span class="sd">                [&#39;name&#39;, &#39;String&#39;],</span>
<span class="sd">                [&#39;created_at&#39;, &#39;Date&#39;]</span>
<span class="sd">            ]</span>

<span class="sd">    - *overwrite*: Boolean flag to replace existing attributes with new values if their name/type matches.</span>

<span class="sd">    - *attribute_stats*: A dictionary containing return values from `get_attribute_statistics()`.</span>

<span class="sd">        Structure:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            attribute_stats = {</span>
<span class="sd">                &quot;&lt;dataset_name&gt;&quot;: {</span>
<span class="sd">                    &quot;&lt;field_name&gt;&quot;: &lt;stat_value&gt;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        Use `attribute_stats[&lt;dataset_name&gt;][&lt;field_name&gt;]` to access specific values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># we need 3 more items; description, attribute_label, and display_order</span>
    <span class="n">attribute_map_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;display_order&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attribute_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">attribute</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">attributes</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">attribute_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Delete existing attributes if they no longer exist in an updated layer</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="n">lafound</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attribute_map</span><span class="p">:</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">display_order</span> <span class="o">=</span> <span class="n">attribute</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">la</span><span class="o">.</span><span class="n">attribute</span><span class="p">:</span>
                <span class="n">lafound</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># store description and attribute_label in attribute_map</span>
                <span class="n">attribute</span><span class="p">[</span><span class="n">attribute_map_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">description</span>
                <span class="n">attribute</span><span class="p">[</span><span class="n">attribute_map_dict</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">attribute_label</span>
                <span class="n">attribute</span><span class="p">[</span><span class="n">attribute_map_dict</span><span class="p">[</span><span class="s2">&quot;display_order&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">display_order</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lafound</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Going to delete [</span><span class="si">%s</span><span class="s2">] for [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">la</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">la</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="c1"># Add new layer attributes if they doesn&#39;t exist already</span>
    <span class="k">if</span> <span class="n">attribute_map</span><span class="p">:</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Attribute</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">layer</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attribute_map</span><span class="p">:</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">display_order</span> <span class="o">=</span> <span class="n">attribute</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">_gs_attrs</span> <span class="o">=</span> <span class="n">Attribute</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_gs_attrs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">la</span> <span class="o">=</span> <span class="n">_gs_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_gs_attrs</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">_gs_attrs</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="n">la</span> <span class="o">=</span> <span class="n">Attribute</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="n">ftype</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;gml:&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">attribute_type</span> <span class="o">=</span> <span class="n">ftype</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">attribute_label</span> <span class="o">=</span> <span class="n">label</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">display_order</span> <span class="o">=</span> <span class="nb">iter</span>
                    <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attribute_stats</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attribute_stats</span> <span class="ow">or</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attribute_stats</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">attribute_stats</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating layer attribute statistics&quot;</span><span class="p">)</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Min&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Max&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">average</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Average&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">median</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Median&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">stddev</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;StandardDeviation&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Sum&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">unique_values</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">last_stats_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">la</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No attributes found&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_attributes_from_geoserver">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_attributes_from_geoserver">[docs]</a>
<span class="k">def</span> <span class="nf">set_attributes_from_geoserver</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve layer attribute names &amp; types from Geoserver,</span>
<span class="sd">    then store in GeoNode database using Attribute model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s2">&quot;remote_service&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="p">:</span>
        <span class="n">server_url</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">service_url</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GetCapabilities&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;GetCapabilities&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;methods&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_method</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GetCapabilities&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;methods&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">_method</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                    <span class="n">server_url</span> <span class="o">=</span> <span class="n">_method</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">server_url</span><span class="p">)</span>
                    <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">server_url</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span>
    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tileStore&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">ptype</span> <span class="o">==</span> <span class="s2">&quot;gxp_arcrestsource&quot;</span><span class="p">:</span>
        <span class="n">dft_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_url</span><span class="si">}{</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">layer</span><span class="o">.</span><span class="n">typename</span><span class="p">)</span><span class="si">}</span><span class="s2">?f=json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The code below will fail if http_client cannot be imported</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dft_url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">_esri_types</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]]]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;vector&quot;</span><span class="p">,</span> <span class="s2">&quot;tileStore&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">,</span> <span class="s2">&quot;wmsStore&quot;</span><span class="p">,</span> <span class="s2">&quot;vector_time&quot;</span><span class="p">}:</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">else</span> <span class="n">layer</span><span class="o">.</span><span class="n">typename</span>
        <span class="n">dft_url_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\/wms\/?$&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">server_url</span><span class="p">)</span>
        <span class="n">dft_query</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="s2">&quot;wfs&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;DescribeFeatureType&quot;</span><span class="p">,</span> <span class="s2">&quot;typename&quot;</span><span class="p">:</span> <span class="n">typename</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">dft_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">dft_url_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ows?</span><span class="si">{</span><span class="n">dft_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The code below will fail if http_client cannot be imported or WFS not supported</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dft_url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">xsd</span> <span class="o">=</span> <span class="s2">&quot;{http://www.w3.org/2001/XMLSchema}&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.//</span><span class="si">{</span><span class="n">xsd</span><span class="si">}</span><span class="s2">extension/</span><span class="si">{</span><span class="n">xsd</span><span class="si">}</span><span class="s2">sequence/</span><span class="si">{</span><span class="n">xsd</span><span class="si">}</span><span class="s2">element&quot;</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Try WMS instead</span>
            <span class="n">dft_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">server_url</span>
                <span class="o">+</span> <span class="s2">&quot;?&quot;</span>
                <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="s2">&quot;wms&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;GetFeatureInfo&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">bbox</span><span class="p">]),</span>
                        <span class="s2">&quot;LAYERS&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span>
                        <span class="s2">&quot;QUERY_LAYERS&quot;</span><span class="p">:</span> <span class="n">typename</span><span class="p">,</span>
                        <span class="s2">&quot;feature_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;srs&quot;</span><span class="p">:</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;info_format&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dft_url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;lxml&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">string</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span>
                    <span class="n">attribute_map</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;xsd:string&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raster&quot;</span><span class="p">]:</span>
        <span class="n">typename</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">else</span> <span class="n">layer</span><span class="o">.</span><span class="n">typename</span>
        <span class="n">dc_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">server_url</span><span class="si">}</span><span class="s2">wcs?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">({</span><span class="s1">&#39;service&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;wcs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;version&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.1.0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;request&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;DescribeCoverage&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;identifiers&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">typename</span><span class="p">})</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dc_url</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="s2">&quot;{http://www.opengis.net/wcs/1.1.1}&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.//</span><span class="si">{</span><span class="n">wcs</span><span class="si">}</span><span class="s2">Axis/</span><span class="si">{</span><span class="n">wcs</span><span class="si">}</span><span class="s2">AvailableKeys/</span><span class="si">{</span><span class="n">wcs</span><span class="si">}</span><span class="s2">Key&quot;</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[[</span><span class="n">n</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="n">attribute_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Get attribute statistics &amp; package for call to really_set_attributes()</span>
    <span class="n">attribute_stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Add new layer attributes if they don&#39;t already exist</span>
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attribute_map</span><span class="p">:</span>
        <span class="n">field</span><span class="p">,</span> <span class="n">ftype</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Attribute</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">is_dataset_attribute_aggregable</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">subtype</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ftype</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating layer attribute statistics&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_attribute_statistics</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">typename</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">attribute_stats</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">set_attributes</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute_map</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">attribute_stats</span><span class="o">=</span><span class="n">attribute_stats</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_dataset">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">):</span>
    <span class="n">gs_catalog</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">gs_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">gs_dataset</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">typename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;No GeoServer Dataset found!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gs_dataset</span></div>



<div class="viewcode-block" id="clean_styles">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.clean_styles">[docs]</a>
<span class="k">def</span> <span class="nf">clean_styles</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Cleanup Styles without a Workspace</span>
        <span class="n">gs_catalog</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">get_dataset</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;clean_styles: Retrieving style &quot;</span><span class="si">{</span><span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; for cleanup&#39;</span><span class="p">)</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
            <span class="n">gs_catalog</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;clean_styles: Style removed: </span><span class="si">{</span><span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;clean_styles: Style does not exist: </span><span class="si">{</span><span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not clean style for layer </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not clean style for layer </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - STACK INFO&quot;</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_styles">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_styles">[docs]</a>
<span class="k">def</span> <span class="nf">set_styles</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">:</span> <span class="n">Catalog</span><span class="p">):</span>
    <span class="n">style_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">get_dataset</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gs_dataset</span><span class="p">:</span>
        <span class="n">default_style</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">get_full_default_style</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">default_style</span><span class="p">:</span>
            <span class="c1"># make sure we are not using a default SLD (which won&#39;t be editable)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="p">,</span> <span class="n">_gs_default_style</span> <span class="o">=</span> <span class="n">save_style</span><span class="p">(</span><span class="n">default_style</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">default_style</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">_gs_default_style</span><span class="o">.</span><span class="n">name</span>
                    <span class="ow">or</span> <span class="n">default_style</span><span class="o">.</span><span class="n">workspace</span> <span class="o">!=</span> <span class="n">_gs_default_style</span><span class="o">.</span><span class="n">workspace</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;set_style: Setting default style &quot;</span><span class="si">{</span><span class="n">_gs_default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; for layer &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="n">gs_dataset</span><span class="o">.</span><span class="n">default_style</span> <span class="o">=</span> <span class="n">_gs_default_style</span>
                    <span class="n">gs_catalog</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gs_dataset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">default_style</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEFAULT_STYLE_NAME</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;set_style: Retrieving no-workspace default style &quot;</span><span class="si">{</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; for deletion&#39;</span>
                        <span class="p">)</span>
                        <span class="n">style_to_delete</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">style_to_delete</span><span class="p">:</span>
                            <span class="n">gs_catalog</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">style_to_delete</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_style: No-ws default style deleted: </span><span class="si">{</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set_style: No-ws default style does not exist: </span><span class="si">{</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Error setting default style &quot;</span><span class="si">{</span><span class="n">_gs_default_style</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; for layer &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>

            <span class="n">style_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">styles</span><span class="p">:</span>
                <span class="n">alt_styles</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">styles</span>
                <span class="k">for</span> <span class="n">alt_style</span> <span class="ow">in</span> <span class="n">alt_styles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">alt_style</span>
                        <span class="ow">and</span> <span class="n">alt_style</span><span class="o">.</span><span class="n">name</span>
                        <span class="ow">and</span> <span class="n">alt_style</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">name</span>
                        <span class="ow">and</span> <span class="n">alt_style</span><span class="o">.</span><span class="n">workspace</span> <span class="o">!=</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="o">.</span><span class="n">workspace</span>
                    <span class="p">):</span>
                        <span class="n">_s</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">save_style</span><span class="p">(</span><span class="n">alt_style</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
                        <span class="n">style_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">style_set</span><span class="p">:</span>
        <span class="c1"># Remove duplicates</span>
        <span class="n">style_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">style_set</span><span class="p">))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style_set</span><span class="p">)</span>

    <span class="n">clean_styles</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">)</span>

    <span class="c1"># Update default style to database</span>
    <span class="n">to_update</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default_style&quot;</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="p">}</span>

    <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">to_update</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

    <span class="c1"># Legend links</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; -- Resource Links[Legend link] for layer </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">geonode.base.models</span> <span class="kn">import</span> <span class="n">Link</span>

        <span class="n">dataset_legends</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">resourcebase_ptr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">default_style</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                <span class="n">style_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">sld_url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">legend_url</span> <span class="o">=</span> <span class="n">get_legend_url</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">style_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dataset_legends</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">resourcebase_ptr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">legend_url</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span>
                        <span class="n">resource</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">resourcebase_ptr</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">legend_url</span><span class="p">,</span>
                        <span class="n">defaults</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">legend_url</span><span class="p">,</span>
                            <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
                            <span class="n">link_type</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; -- Resource Links[Legend link]...done!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; -- Resource Links[Legend link]...error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">set_geowebcache_invalidate_cache</span>

        <span class="n">set_geowebcache_invalidate_cache</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">typename</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="n">gs_catalog</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_style">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.save_style">[docs]</a>
<span class="k">def</span> <span class="nf">save_style</span><span class="p">(</span><span class="n">gs_style</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
    <span class="n">style_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">gs_style</span><span class="o">.</span><span class="n">body_href</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sld_name</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gs_style</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">sld_body</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gs_style</span><span class="o">.</span><span class="n">sld_body</span><span class="p">)</span>
    <span class="n">_gs_style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">workspace</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;save_style: Copying style &quot;</span><span class="si">{</span><span class="n">sld_name</span><span class="si">}</span><span class="s1">&quot; to &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">_gs_style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">create_style</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sld_body</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;save_style: Retrieving style &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">sld_name</span><span class="si">}</span><span class="s1">&quot; for layer &quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">_gs_style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">sld_name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">style</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Style</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">)</span>
        <span class="n">style</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">workspace</span>
        <span class="n">style</span><span class="o">.</span><span class="n">sld_title</span> <span class="o">=</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">sld_title</span> <span class="k">if</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">style_format</span> <span class="o">!=</span> <span class="s2">&quot;css&quot;</span> <span class="ow">and</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">sld_title</span> <span class="k">else</span> <span class="n">sld_name</span>
        <span class="n">style</span><span class="o">.</span><span class="n">sld_body</span> <span class="o">=</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">sld_body</span>
        <span class="n">style</span><span class="o">.</span><span class="n">sld_url</span> <span class="o">=</span> <span class="n">_gs_style</span><span class="o">.</span><span class="n">body_href</span>
        <span class="n">style</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">_gs_style</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_dataset_attribute_aggregable">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.is_dataset_attribute_aggregable">[docs]</a>
<span class="k">def</span> <span class="nf">is_dataset_attribute_aggregable</span><span class="p">(</span><span class="n">store_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decipher whether layer attribute is suitable for statistical derivation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># must be vector layer</span>
    <span class="k">if</span> <span class="n">store_type</span> <span class="o">!=</span> <span class="s2">&quot;dataStore&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># must be a numeric data type</span>
    <span class="k">if</span> <span class="n">field_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LAYER_ATTRIBUTE_NUMERIC_DATA_TYPES</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># must not be an identifier type field</span>
    <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="get_attribute_statistics">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_attribute_statistics">[docs]</a>
<span class="k">def</span> <span class="nf">get_attribute_statistics</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate statistics (range, mean, median, standard deviation, unique values)</span>
<span class="sd">    for layer attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deriving aggregate statistics for attribute </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">WPS_ENABLED</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wps_execute_dataset_attribute_statistics</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error generating layer aggregate statistics&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_wcs_record">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_wcs_record">[docs]</a>
<span class="k">def</span> <span class="nf">get_wcs_record</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WebCoverageService</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="si">}</span><span class="s2">wcs&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">workspace</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wcs</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wcs</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Dataset &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; was not found in WCS service at </span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">public_url</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> Waiting a couple of seconds before trying again.&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">get_wcs_record</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_coverage_grid_extent">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_coverage_grid_extent">[docs]</a>
<span class="k">def</span> <span class="nf">get_coverage_grid_extent</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of integers with the size of the coverage</span>
<span class="sd">    extent in pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance_wcs</span> <span class="o">=</span> <span class="n">get_wcs_record</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">instance_wcs</span><span class="o">.</span><span class="n">grid</span>
    <span class="k">return</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">highlimits</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">lowlimits</span><span class="p">)]</span></div>



<div class="viewcode-block" id="GEOSERVER_LAYER_TYPES">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.GEOSERVER_LAYER_TYPES">[docs]</a>
<span class="n">GEOSERVER_LAYER_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">FeatureType</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span>
    <span class="s2">&quot;raster&quot;</span><span class="p">:</span> <span class="n">Coverage</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span>
<span class="p">}</span></div>



<div class="viewcode-block" id="cleanup">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.cleanup">[docs]</a>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deletes GeoServer and Catalogue records for a given name.</span>
<span class="sd">    Useful to clean the mess when something goes terribly wrong.</span>
<span class="sd">    It also verifies if the Django record existed, in which case</span>
<span class="sd">    it performs no action.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not doing any cleanup because the layer </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> exists in the Django db.&quot;</span>
        <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">gs_store</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gs_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gs_resource</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># FIXME: Could this lead to someone deleting for example a postgis db</span>
    <span class="c1"># with the same name of the uploaded file?.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs_store</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gs_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gs_dataset</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gs_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">gs_dataset</span><span class="o">.</span><span class="n">resource</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gs_dataset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gs_resource</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">FailedRequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Couldn&#39;t connect to GeoServer while cleaning up layer &quot;</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] !!&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gs_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">gs_dataset</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t delete GeoServer layer during cleanup()&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gs_resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">gs_resource</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t delete GeoServer resource during cleanup()&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gs_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">gs_store</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t delete GeoServer store during cleanup()&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Deleting dangling Catalogue record for [</span><span class="si">%s</span><span class="s2">] &quot;</span> <span class="s2">&quot;(no Django record to match)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;geonode.catalogue&quot;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">geonode.catalogue</span> <span class="kn">import</span> <span class="n">get_catalogue</span>

        <span class="n">catalogue</span> <span class="o">=</span> <span class="n">get_catalogue</span><span class="p">()</span>
        <span class="n">catalogue</span><span class="o">.</span><span class="n">remove_record</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Finished cleanup after failed Catalogue/Django &quot;</span> <span class="s2">&quot;import for layer: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_geoserver_db_featurestore">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.create_geoserver_db_featurestore">[docs]</a>
<span class="k">def</span> <span class="nf">create_geoserver_db_featurestore</span><span class="p">(</span>
    <span class="n">store_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">store_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">author_name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="n">author_email</span><span class="o">=</span><span class="s2">&quot;admin@geonode.org&quot;</span><span class="p">,</span>
    <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span>
    <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">dsname</span> <span class="o">=</span> <span class="n">store_name</span> <span class="ow">or</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">DATASTORE</span>
    <span class="c1"># get or create datastore</span>
    <span class="n">ds_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dsname</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FailedRequestError</span>
        <span class="n">ds_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating target datastore </span><span class="si">{</span><span class="n">dsname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">create_datastore</span><span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">datastore_db</span>
        <span class="n">db_engine</span> <span class="o">=</span> <span class="s2">&quot;postgis&quot;</span> <span class="k">if</span> <span class="s2">&quot;postgis&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;ENGINE&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;ENGINE&quot;</span><span class="p">]</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">connection_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Evictor run periodicity&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s2">&quot;Estimated extends&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fetch size&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                <span class="s2">&quot;encode functions&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Expose primary keys&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;validate connections&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Support on the fly geometry simplification&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Connection timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;create database&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Batch insert size&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                <span class="s2">&quot;preparedStatements&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min connections&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;max connections&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;Evictor tests per run&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;Max connection idle time&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s2">&quot;Loose bbox&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Test while idle&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;HOST&quot;</span><span class="p">],</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;PORT&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PORT&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PORT&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="s2">&quot;5432&quot;</span><span class="p">,</span>
                <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">],</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;USER&quot;</span><span class="p">],</span>
                <span class="s2">&quot;passwd&quot;</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">],</span>
                <span class="s2">&quot;dbtype&quot;</span><span class="p">:</span> <span class="n">db_engine</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_exists</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">save_method</span> <span class="o">=</span> <span class="s2">&quot;PUT&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating target datastore </span><span class="si">% s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dsname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FailedRequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;already exists in workspace&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The store was already present in the workspace selected&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reloading target datastore </span><span class="si">% s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dsname</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">enabled</span>

    <span class="k">return</span> <span class="n">ds</span></div>



<div class="viewcode-block" id="_create_featurestore">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._create_featurestore">[docs]</a>
<span class="k">def</span> <span class="nf">_create_featurestore</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">create_featurestore</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">store</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span></div>



<div class="viewcode-block" id="_create_coveragestore">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._create_coveragestore">[docs]</a>
<span class="k">def</span> <span class="nf">_create_coveragestore</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">create_coveragestore</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">upload_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">store</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span></div>



<div class="viewcode-block" id="_create_db_featurestore">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._create_db_featurestore">[docs]</a>
<span class="k">def</span> <span class="nf">_create_db_featurestore</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a database store then use it to import a shapefile.</span>

<span class="sd">    If the import into the database fails then delete the store</span>
<span class="sd">    (and delete the PostGIS table for it).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">gs_catalog</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">datastore_db</span>
    <span class="c1"># dsname = ogc_server_settings.DATASTORE</span>
    <span class="n">dsname</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">create_geoserver_db_featurestore</span><span class="p">(</span><span class="n">store_name</span><span class="o">=</span><span class="n">dsname</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">add_data_to_store</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ds</span><span class="p">,</span> <span class="n">resource</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An exception occurred loading data to PostGIS&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">delete_from_postgis</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot; Additionally an error occured during database cleanup&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_store">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_store">[docs]</a>
<span class="k">def</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Make sure workspace is a workspace object and not a string.</span>
    <span class="c1"># If the workspace does not exist, continue as if no workspace had been defined.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_workspace</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">workspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">workspace</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_default_workspace</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">workspace</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="o">.</span><span class="n">datastore_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="o">.</span><span class="n">coveragestore_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">store</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_xml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="o">.</span><span class="n">wmsstore_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FailedRequestError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FailedRequestError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No store found named: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">store</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">store</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;dataStore&quot;</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">datastore_from_index</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">store</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;coverageStore&quot;</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">coveragestore_from_index</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">store</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;wmsStore&quot;</span><span class="p">:</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">wmsstore_from_index</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">store</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FailedRequestError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No store found named: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FailedRequestError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No store found named: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="fetch_gs_resource">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.fetch_gs_resource">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_gs_resource</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">tries</span><span class="p">):</span>
    <span class="n">_max_tries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ogc_server_settings</span><span class="p">,</span> <span class="s2">&quot;MAX_RETRIES&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">workspace</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">workspace</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">alternate</span> <span class="ow">or</span> <span class="n">instance</span><span class="o">.</span><span class="n">typename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">gs_resource</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">gs_resource</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">gs_resource</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">gs_resource</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;abstract&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">_subtype</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">resource_type</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gs_resource</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">enabled</span>
        <span class="p">):</span>
            <span class="n">_subtype</span> <span class="o">=</span> <span class="s2">&quot;vectorTimeSeries&quot;</span>

        <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">store</span><span class="o">=</span><span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">subtype</span><span class="o">=</span><span class="n">_subtype</span><span class="p">,</span>
                <span class="n">alternate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">gs_resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">gs_resource</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">abstract</span><span class="o">=</span><span class="n">gs_resource</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">owner</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;There isn&#39;t a geoserver resource for this layer: </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">_max_tries</span><span class="p">:</span>
            <span class="c1"># raise GeoNodeException(msg)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">gs_resource</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">gs_resource</span><span class="p">)</span></div>



<div class="viewcode-block" id="wps_execute_dataset_attribute_statistics">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.wps_execute_dataset_attribute_statistics">[docs]</a>
<span class="k">def</span> <span class="nf">wps_execute_dataset_attribute_statistics</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Derive aggregate statistics from WPS endpoint&quot;&quot;&quot;</span>

    <span class="c1"># generate statistics using WPS</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">,</span> <span class="s2">&quot;ows&quot;</span><span class="p">)</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s2">&quot;layers/wps_execute_gs_aggregate.xml&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">})</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;OWSLib (https://geopython.github.io/OWSLib)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/xml&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;text/xml&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip,deflate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Host&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">exml</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Min&quot;</span><span class="p">,</span> <span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="s2">&quot;Average&quot;</span><span class="p">,</span> <span class="s2">&quot;Median&quot;</span><span class="p">,</span> <span class="s2">&quot;StandardDeviation&quot;</span><span class="p">,</span> <span class="s2">&quot;Sum&quot;</span><span class="p">]:</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">exml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">exml</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="_stylefilterparams_geowebcache_dataset">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._stylefilterparams_geowebcache_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">_stylefilterparams_geowebcache_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/xml&quot;</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="si">}</span><span class="s2">gwc/rest/layers/</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">.xml&quot;</span>

    <span class="c1"># read GWC configuration</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> reading Style Filter Params GeoWebCache at </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># check/write GWC filter parameters</span>
    <span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
    <span class="n">param_filters</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;parameterFilters&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">param_filters</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;styleParameterFilter&quot;</span><span class="p">):</span>
            <span class="n">style_filters_xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;styleParameterFilter&gt;&lt;key&gt;STYLES&lt;/key&gt;</span><span class="se">\</span>
<span class="s2">                &lt;defaultValue&gt;&lt;/defaultValue&gt;&lt;/styleParameterFilter&gt;&quot;</span>
            <span class="n">style_filters_elem</span> <span class="o">=</span> <span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">style_filters_xml</span><span class="p">)</span>
            <span class="n">param_filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">style_filters_elem</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
        <span class="n">req</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> writing Style Filter Params GeoWebCache at </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="_invalidate_geowebcache_dataset">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._invalidate_geowebcache_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">_invalidate_geowebcache_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># http.add_credentials(username, password)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/xml&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;truncateLayer&gt;&lt;layerName&gt;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&lt;/layerName&gt;&lt;/truncateLayer&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">LOCATION</span><span class="si">}</span><span class="s2">gwc/rest/masstruncate&quot;</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">_user</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> invalidating GeoWebCache at </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="style_update">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.style_update">[docs]</a>
<span class="k">def</span> <span class="nf">style_update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync style stuff from GS to GN.</span>
<span class="sd">    Ideally we should call this from a view straight from GXP, and we should use</span>
<span class="sd">    gsConfig, that at this time does not support styles updates. Before gsConfig</span>
<span class="sd">    is updated, for now we need to parse xml.</span>
<span class="sd">    In case of a DELETE, we need to query request.path to get the style name,</span>
<span class="sd">    and then remove it.</span>
<span class="sd">    In case of a POST or PUT, we need to parse the xml from</span>
<span class="sd">    request.body, which is in this format:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">affected_datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">):</span>  <span class="c1"># we need to parse xml</span>
        <span class="c1"># Need to remove NSx from IE11</span>
        <span class="k">if</span> <span class="s2">&quot;HTTP_USER_AGENT&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Trident/7.0&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_USER_AGENT&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;rv:11.0&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_USER_AGENT&quot;</span><span class="p">]:</span>
                <span class="n">txml</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;xmlns:NS[0-9]=&quot;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="n">txml</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;NS[0-9]:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">txml</span><span class="p">)</span>
                <span class="n">request</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="n">txml</span>
        <span class="n">style_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sld_title</span> <span class="o">=</span> <span class="n">style_name</span>
        <span class="n">sld_body</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sld_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
            <span class="n">style_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">sld_body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="n">style_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sld_body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="n">gs_style</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">gs_style</span><span class="p">:</span>
                <span class="n">sld_title</span> <span class="o">=</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">sld_title</span> <span class="k">if</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">style_format</span> <span class="o">!=</span> <span class="s2">&quot;css&quot;</span> <span class="ow">and</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">sld_title</span> <span class="k">else</span> <span class="n">style_name</span>
                <span class="n">sld_body</span> <span class="o">=</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">sld_body</span>
                <span class="n">sld_url</span> <span class="o">=</span> <span class="n">gs_style</span><span class="o">.</span><span class="n">body_href</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">dlxml</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
                    <span class="n">elm_nameddataset_name</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//{http://www.opengis.net/sld}Name&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">elm_user_style_name</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//{http://www.opengis.net/sld}Name&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">elm_user_style_title</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//{http://www.opengis.net/sld}Title&quot;</span><span class="p">)</span>
                    <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">elm_nameddataset_name</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="n">elm_user_style_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sld_title</span> <span class="o">=</span> <span class="n">elm_user_style_name</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sld_title</span> <span class="o">=</span> <span class="n">elm_user_style_title</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">sld_body</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not recognize Style and Dataset name from Request!&quot;</span><span class="p">)</span>

        <span class="c1"># add style in GN and associate it to layer</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">style_name</span><span class="p">:</span>
                <span class="n">Style</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">style_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">temp_style_name_regex</span><span class="p">,</span> <span class="n">style_name</span><span class="p">):</span>
                <span class="n">style</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Style</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">)</span>
                <span class="n">style</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">workspace</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_body</span> <span class="o">=</span> <span class="n">sld_body</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_url</span> <span class="o">=</span> <span class="n">sld_url</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_title</span> <span class="o">=</span> <span class="n">sld_title</span>
                <span class="n">style</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dataset_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                    <span class="n">style</span><span class="o">.</span><span class="n">dataset_styles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="n">style</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">affected_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>  <span class="c1"># update style in GN</span>
            <span class="k">if</span> <span class="n">style_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">temp_style_name_regex</span><span class="p">,</span> <span class="n">style_name</span><span class="p">):</span>
                <span class="n">style</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Style</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">style_name</span><span class="p">)</span>
                <span class="n">style</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">workspace</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_body</span> <span class="o">=</span> <span class="n">sld_body</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_url</span> <span class="o">=</span> <span class="n">sld_url</span>
                <span class="n">style</span><span class="o">.</span><span class="n">sld_title</span> <span class="o">=</span> <span class="n">sld_title</span>
                <span class="n">style</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">style</span><span class="o">.</span><span class="n">dataset_styles</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">affected_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="c1"># Invalidate GeoWebCache so it doesn&#39;t retain old style in tiles</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset_name</span><span class="p">:</span>
                <span class="n">_stylefilterparams_geowebcache_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
                <span class="n">_invalidate_geowebcache_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">affected_datasets</span></div>



<div class="viewcode-block" id="set_time_info">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_time_info">[docs]</a>
<span class="k">def</span> <span class="nf">set_time_info</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">end_attribute</span><span class="p">,</span> <span class="n">presentation</span><span class="p">,</span> <span class="n">precision_value</span><span class="p">,</span> <span class="n">precision_step</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure the time dimension for a layer.</span>

<span class="sd">    :param layer: the layer to configure</span>
<span class="sd">    :param attribute: the attribute used to represent the instant or period</span>
<span class="sd">                      start</span>
<span class="sd">    :param end_attribute: the optional attribute used to represent the end</span>
<span class="sd">                          period</span>
<span class="sd">    :param presentation: either &#39;LIST&#39;, &#39;DISCRETE_INTERVAL&#39;, or</span>
<span class="sd">                         &#39;CONTINUOUS_INTERVAL&#39;</span>
<span class="sd">    :param precision_value: number representing number of steps</span>
<span class="sd">    :param precision_step: one of &#39;seconds&#39;, &#39;minutes&#39;, &#39;hours&#39;, &#39;days&#39;,</span>
<span class="sd">                           &#39;months&#39;, &#39;years&#39;</span>
<span class="sd">    :param enabled: defaults to True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such layer: </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">resource</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">resolution</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">precision_value</span> <span class="ow">and</span> <span class="n">precision_step</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">precision_value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">precision_step</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">DimensionInfo</span><span class="p">(</span>
        <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">presentation</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attribute</span><span class="p">,</span> <span class="n">end_attribute</span><span class="o">=</span><span class="n">end_attribute</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">resource</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

    <span class="k">if</span> <span class="n">resource</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
        <span class="n">gs_catalog</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_time_info">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_time_info">[docs]</a>
<span class="k">def</span> <span class="nf">get_time_info</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the configured time dimension metadata for the layer as a dict.</span>

<span class="sd">    The keys of the dict will be those of the parameters of `set_time_info`.</span>

<span class="sd">    :returns: dict of values or None if not configured</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no such layer: </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">resource</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">gs_catalog</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">resolution_str</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resolution</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">resolution</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span>
            <span class="n">attribute</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span>
            <span class="n">end_attribute</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">end_attribute</span><span class="p">,</span>
            <span class="n">presentation</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">presentation</span><span class="p">,</span>
            <span class="n">precision_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">precision_step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">vals</span></div>



<div class="viewcode-block" id="ogc_server_settings">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.ogc_server_settings">[docs]</a>
<span class="n">ogc_server_settings</span> <span class="o">=</span> <span class="n">OGC_Servers_Handler</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">)[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="_wms">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._wms">[docs]</a>
<span class="n">_wms</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="_csw">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._csw">[docs]</a>
<span class="n">_csw</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="n">_user</span><span class="p">,</span> <span class="n">_password</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">credentials</span>

<div class="viewcode-block" id="url">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.url">[docs]</a>
<span class="n">url</span> <span class="o">=</span> <span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">rest</span></div>

<div class="viewcode-block" id="gs_catalog">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.gs_catalog">[docs]</a>
<span class="n">gs_catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">_user</span><span class="p">,</span> <span class="n">_password</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="n">ogc_server_settings</span><span class="o">.</span><span class="n">BACKOFF_FACTOR</span>
<span class="p">)</span></div>

<div class="viewcode-block" id="gs_uploader">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.gs_uploader">[docs]</a>
<span class="n">gs_uploader</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">_user</span><span class="p">,</span> <span class="n">_password</span><span class="p">)</span></div>



<div class="viewcode-block" id="_create_acl_client">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._create_acl_client">[docs]</a>
<span class="k">def</span> <span class="nf">_create_acl_client</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AclClient</span><span class="p">()</span>
    <span class="c1"># client.set_timeout(ogc_server_settings.ACL_TIMEOUT)</span>
    <span class="k">return</span> <span class="n">client</span></div>



<div class="viewcode-block" id="acl">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.acl">[docs]</a>
<span class="n">acl</span> <span class="o">=</span> <span class="n">_create_acl_client</span><span class="p">()</span></div>

<div class="viewcode-block" id="acl_utils">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.acl_utils">[docs]</a>
<span class="n">acl_utils</span> <span class="o">=</span> <span class="n">AclUtils</span><span class="p">(</span><span class="n">acl</span><span class="p">)</span></div>


<div class="viewcode-block" id="_punc">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._punc">[docs]</a>
<span class="n">_punc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\.:]&quot;</span><span class="p">)</span>  <span class="c1"># regex for punctuation that confuses restconfig</span></div>

<div class="viewcode-block" id="_foregrounds">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._foregrounds">[docs]</a>
<span class="n">_foregrounds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#ffbbbb&quot;</span><span class="p">,</span> <span class="s2">&quot;#bbffbb&quot;</span><span class="p">,</span> <span class="s2">&quot;#bbbbff&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffffbb&quot;</span><span class="p">,</span> <span class="s2">&quot;#bbffff&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffbbff&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_backgrounds">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._backgrounds">[docs]</a>
<span class="n">_backgrounds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#880000&quot;</span><span class="p">,</span> <span class="s2">&quot;#008800&quot;</span><span class="p">,</span> <span class="s2">&quot;#000088&quot;</span><span class="p">,</span> <span class="s2">&quot;#888800&quot;</span><span class="p">,</span> <span class="s2">&quot;#008888&quot;</span><span class="p">,</span> <span class="s2">&quot;#880088&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_marks">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._marks">[docs]</a>
<span class="n">_marks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_style_contexts">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._style_contexts">[docs]</a>
<span class="n">_style_contexts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">(</span><span class="n">_foregrounds</span><span class="p">),</span> <span class="n">cycle</span><span class="p">(</span><span class="n">_backgrounds</span><span class="p">),</span> <span class="n">cycle</span><span class="p">(</span><span class="n">_marks</span><span class="p">))</span></div>

<div class="viewcode-block" id="_default_style_names">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._default_style_names">[docs]</a>
<span class="n">_default_style_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;raster&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_esri_types">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._esri_types">[docs]</a>
<span class="n">_esri_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;esriFieldTypeDouble&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:double&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeString&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:string&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeSmallInteger&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:int&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeInteger&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:int&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeDate&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:dateTime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeOID&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:long&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeGeometry&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:geometry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeBlob&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:base64Binary&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeRaster&quot;</span><span class="p">:</span> <span class="s2">&quot;raster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeGUID&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:string&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeGlobalID&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:string&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esriFieldTypeXML&quot;</span><span class="p">:</span> <span class="s2">&quot;xsd:anyType&quot;</span><span class="p">,</span>
<span class="p">}</span></div>



<div class="viewcode-block" id="_dump_image_spec">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers._dump_image_spec">[docs]</a>
<span class="k">def</span> <span class="nf">_dump_image_spec</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="n">image_spec</span><span class="p">):</span>
    <span class="n">millis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
            <span class="n">_request_body_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;request_body_</span><span class="si">{</span><span class="n">millis</span><span class="si">}</span><span class="s2">.dump&quot;</span><span class="p">)</span>
            <span class="n">_image_spec_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;image_spec_</span><span class="si">{</span><span class="n">millis</span><span class="si">}</span><span class="s2">.dump&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_request_body_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_request_body_file</span><span class="p">:</span>
                <span class="n">_request_body_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request_body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">_request_body_file_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;request_body_</span><span class="si">{</span><span class="n">millis</span><span class="si">}</span><span class="s2">.dump&quot;</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_image_spec_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_image_spec_file</span><span class="p">:</span>
                <span class="n">_image_spec_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">_image_spec_file_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;image_spec_</span><span class="si">{</span><span class="n">millis</span><span class="si">}</span><span class="s2">.dump&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Dumping image_spec to: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;image_spec_</span><span class="si">{</span><span class="n">millis</span><span class="si">}</span><span class="s1">.dump&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Unable to dump image_spec for request: </span><span class="si">{</span><span class="n">request_body</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="mosaic_delete_first_granule">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.mosaic_delete_first_granule">[docs]</a>
<span class="k">def</span> <span class="nf">mosaic_delete_first_granule</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
    <span class="c1"># - since GeoNode will uploade the first granule again through the Importer, we need to /</span>
    <span class="c1">#   delete the one created by the gs_config</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">coverages</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">mosaic_coverages</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>

    <span class="n">granule_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.1&quot;</span>

    <span class="n">cat</span><span class="o">.</span><span class="n">mosaic_delete_granule</span><span class="p">(</span><span class="n">coverages</span><span class="p">[</span><span class="s2">&quot;coverages&quot;</span><span class="p">][</span><span class="s2">&quot;coverage&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">store</span><span class="p">,</span> <span class="n">granule_id</span><span class="p">)</span></div>



<div class="viewcode-block" id="set_time_dimension">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.set_time_dimension">[docs]</a>
<span class="k">def</span> <span class="nf">set_time_dimension</span><span class="p">(</span>
    <span class="n">cat</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">workspace</span><span class="p">,</span>
    <span class="n">time_presentation</span><span class="p">,</span>
    <span class="n">time_presentation_res</span><span class="p">,</span>
    <span class="n">time_presentation_default_value</span><span class="p">,</span>
    <span class="n">time_presentation_reference_value</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># configure the layer time dimension as LIST</span>
    <span class="n">presentation</span> <span class="o">=</span> <span class="n">time_presentation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">presentation</span><span class="p">:</span>
        <span class="n">presentation</span> <span class="o">=</span> <span class="s2">&quot;LIST&quot;</span>

    <span class="n">resolution</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">time_presentation</span> <span class="o">==</span> <span class="s2">&quot;DISCRETE_INTERVAL&quot;</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="n">time_presentation_res</span>

    <span class="n">strategy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">time_presentation_default_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_presentation_default_value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">time_presentation_default_value</span>

    <span class="n">timeInfo</span> <span class="o">=</span> <span class="n">DimensionInfo</span><span class="p">(</span>
        <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;true&quot;</span><span class="p">,</span>
        <span class="n">presentation</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
        <span class="n">reference_value</span><span class="o">=</span><span class="n">time_presentation_reference_value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">resource</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="ow">or</span> <span class="n">cat</span><span class="o">.</span><span class="n">get_resources</span><span class="p">(</span><span class="n">stores</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">workspaces</span><span class="o">=</span><span class="p">[</span><span class="n">workspace</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No resource could be found on GeoServer with name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No resource could be found on GeoServer with name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">resource</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">timeInfo</span><span class="p">}</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span></div>



<span class="c1"># main entry point to create a thumbnail - will use implementation</span>
<span class="c1"># defined in settings.THUMBNAIL_GENERATOR (see settings.py)</span>
<div class="viewcode-block" id="create_gs_thumbnail">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.create_gs_thumbnail">[docs]</a>
<span class="k">def</span> <span class="nf">create_gs_thumbnail</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_bbox</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">THUMBNAIL_GENERATOR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">implementation</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">check_bbox</span><span class="p">)</span></div>



<div class="viewcode-block" id="sync_instance_with_geoserver">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.sync_instance_with_geoserver">[docs]</a>
<span class="k">def</span> <span class="nf">sync_instance_with_geoserver</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synchronizes the Django Instance with GeoServer layers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">updatebbox</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updatebbox&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">updatemetadata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updatemetadata&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset id </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> does not exist yet!&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ResourceBase</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">set_processing_state</span><span class="p">(</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">updatemetadata</span><span class="p">:</span>
            <span class="c1"># Save layer attributes</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Refresh GeoServer attributes list for Dataset </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_attributes_from_geoserver</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># Don&#39;t run this signal handler if it is a tile layer or a remote store (Service)</span>
        <span class="c1">#    Currently only gpkg files containing tiles will have this type &amp; will be served via MapProxy.</span>
        <span class="n">_is_remote_instance</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tileStore&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span>

        <span class="c1"># Let&#39;s reset the connections first</span>
        <span class="n">gs_catalog</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">gs_catalog</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">gs_resource</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_remote_instance</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_tries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_max_tries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ogc_server_settings</span><span class="p">,</span> <span class="s2">&quot;MAX_RETRIES&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># If the store in None then it&#39;s a new instance from an upload,</span>
            <span class="c1"># only in this case run the geoserver_upload method</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">base_file</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_base_file</span><span class="p">()</span>

                <span class="c1"># There is no need to process it if there is no file.</span>
                <span class="k">if</span> <span class="n">base_file</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">geonode.geoserver.upload</span> <span class="kn">import</span> <span class="n">geoserver_upload</span>

                    <span class="n">gs_name</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">geoserver_upload</span><span class="p">(</span>
                        <span class="n">instance</span><span class="p">,</span>
                        <span class="n">base_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                        <span class="n">abstract</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">abstract</span><span class="p">,</span>
                        <span class="n">charset</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">values</span><span class="p">,</span> <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">fetch_gs_resource</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">_tries</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">gs_resource</span> <span class="ow">and</span> <span class="n">_tries</span> <span class="o">&lt;</span> <span class="n">_max_tries</span><span class="p">:</span>
                <span class="n">values</span><span class="p">,</span> <span class="n">gs_resource</span> <span class="o">=</span> <span class="n">fetch_gs_resource</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">_tries</span><span class="p">)</span>
                <span class="n">_tries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Get metadata links</span>
            <span class="n">metadata_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">link_set</span><span class="o">.</span><span class="n">metadata</span><span class="p">():</span>
                <span class="n">metadata_links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">link</span><span class="o">.</span><span class="n">mime</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">gs_resource</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found geoserver resource for this dataset: </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">gs_resource</span> <span class="o">=</span> <span class="n">gs_resource</span>

                <span class="c1"># Iterate over values from geoserver.</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">]:</span>
                    <span class="c1"># attr_name = key if &#39;typename&#39; not in key else &#39;alternate&#39;</span>
                    <span class="c1"># print attr_name</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">get_dataset_storetype</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">updatemetadata</span><span class="p">:</span>
                    <span class="n">gs_resource</span><span class="o">.</span><span class="n">metadata_links</span> <span class="o">=</span> <span class="n">metadata_links</span>
                    <span class="n">default_poc</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_first_contact_of_role</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;poc&quot;</span><span class="p">)</span>
                    <span class="c1"># Update Attribution link</span>
                    <span class="k">if</span> <span class="n">default_poc</span><span class="p">:</span>
                        <span class="c1"># gsconfig now utilizes an attribution dictionary</span>
                        <span class="n">gs_resource</span><span class="o">.</span><span class="n">attribution</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">poc_csv</span><span class="p">),</span>
                            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">profile</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">default_poc</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
                        <span class="n">site_url</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SITEURL</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITEURL</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITEURL</span>
                        <span class="p">)</span>
                        <span class="n">gs_resource</span><span class="o">.</span><span class="n">attribution_link</span> <span class="o">=</span> <span class="n">site_url</span> <span class="o">+</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESOURCE_PUBLISHING</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">is_published</span> <span class="o">!=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">advertised</span><span class="p">:</span>
                                <span class="n">gs_resource</span><span class="o">.</span><span class="n">advertised</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">keyword_list</span><span class="p">()):</span>
                            <span class="n">keywords</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">keywords</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">keyword_list</span><span class="p">()</span>
                            <span class="n">gs_resource</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keywords</span><span class="p">))</span>

                        <span class="c1"># gs_resource should only be called if</span>
                        <span class="c1"># ogc_server_settings.BACKEND_WRITE_ENABLED == True</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ogc_server_settings</span><span class="p">,</span> <span class="s2">&quot;BACKEND_WRITE_ENABLED&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="n">gs_catalog</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gs_resource</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Error while trying to save resource named </span><span class="si">{</span><span class="n">gs_resource</span><span class="si">}</span><span class="s1"> in GeoServer, try to use: &quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">updatebbox</span><span class="p">:</span>
                    <span class="c1"># store the resource to avoid another geoserver call in the post_save</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Get information from geoserver.</span>
<span class="sd">                    The attributes retrieved include:</span>
<span class="sd">                    * Bounding Box</span>
<span class="sd">                    * SRID</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="c1"># This is usually done in Dataset.pre_save, however if the hooks</span>
                    <span class="c1"># are bypassed by custom create/updates we need to ensure the</span>
                    <span class="c1"># bbox is calculated properly.</span>
                    <span class="n">srid</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">projection</span>
                    <span class="n">bbox</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">native_bbox</span>
                    <span class="n">ll_bbox</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">latlon_bbox</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">set_bbox_polygon</span><span class="p">([</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">srid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">GeoNodeException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ll_bbox</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="n">instance</span><span class="o">.</span><span class="n">srid</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
                            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">srid</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">set_ll_bbox_polygon</span><span class="p">([</span><span class="n">ll_bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ll_bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

                    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">srid</span><span class="p">:</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">srid_url</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;http://www.spatialreference.org/ref/</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">srid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid Projection. Dataset is missing CRS!&quot;</span><span class="p">))</span>

                <span class="c1"># Update the instance</span>
                <span class="n">to_update</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">updatemetadata</span><span class="p">:</span>
                    <span class="n">to_update</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;abstract&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;alternate&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span>
                    <span class="p">}</span>

                <span class="k">if</span> <span class="n">updatebbox</span> <span class="ow">and</span> <span class="n">is_monochromatic_image</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">thumbnail_url</span><span class="p">):</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;thumbnail_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Save all the modified information in the instance without triggering signals.</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
                    <span class="n">ResourceBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">resourcebase_ptr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">to_update</span><span class="p">)</span>

                    <span class="c1"># to_update[&#39;name&#39;] = instance.name,</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gs_resource</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;subtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">subtype</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;typename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">alternate</span>
                    <span class="n">to_update</span><span class="p">[</span><span class="s2">&quot;srid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">srid</span>
                    <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">to_update</span><span class="p">)</span>

                    <span class="c1"># Refresh from DB</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">updatemetadata</span><span class="p">:</span>
                    <span class="c1"># Save dataset styles</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Refresh Legend links for Dataset </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">set_styles</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">gs_catalog</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                    <span class="c1"># Invalidate GeoWebCache for the updated resource</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_stylefilterparams_geowebcache_dataset</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
                        <span class="n">_invalidate_geowebcache_dataset</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># Refreshing dataset links</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Creating Default Resource Links for Dataset </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">set_resource_default_links</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="n">_is_remote_instance</span><span class="p">)</span>

        <span class="c1"># Refreshing CSW records</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;... Updating the Catalogue entries for Dataset </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">catalogue_post_save</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">set_processing_state</span><span class="p">(</span><span class="s2">&quot;PROCESSED&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">set_processing_state</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GeoNodeException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span></div>



<div class="viewcode-block" id="get_dataset_storetype">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_dataset_storetype">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataset_storetype</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LAYER_SUBTYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_uploaded_files_to_disk">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.write_uploaded_files_to_disk">[docs]</a>
<span class="k">def</span> <span class="nf">write_uploaded_files_to_disk</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">django_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">django_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">django_file</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="select_relevant_files">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.select_relevant_files">[docs]</a>
<span class="k">def</span> <span class="nf">select_relevant_files</span><span class="p">(</span><span class="n">allowed_extensions</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter the input files list for relevant files only</span>

<span class="sd">    Relevant files are those whose extension is in the ``allowed_extensions``</span>
<span class="sd">    iterable.</span>

<span class="sd">    :param allowed_extensions: list of strings with the extensions to keep</span>
<span class="sd">    :param files: list of django files with the files to be filtered</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">django_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">_django_file_name</span> <span class="o">=</span> <span class="n">django_file</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">django_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">django_file</span><span class="o">.</span><span class="n">name</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">_django_file_name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">allowed_extensions</span><span class="p">:</span>
                <span class="n">already_selected</span> <span class="o">=</span> <span class="n">_django_file_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">already_selected</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">django_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>



<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">()</span>
<div class="viewcode-block" id="SpatialFilesLayerType">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.SpatialFilesLayerType">[docs]</a>
<span class="k">class</span> <span class="nc">SpatialFilesLayerType</span><span class="p">:</span>
<div class="viewcode-block" id="SpatialFilesLayerType.base_file">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.SpatialFilesLayerType.base_file">[docs]</a>
    <span class="n">base_file</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="SpatialFilesLayerType.scan_hint">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.SpatialFilesLayerType.scan_hint">[docs]</a>
    <span class="n">scan_hint</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="SpatialFilesLayerType.spatial_files">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.SpatialFilesLayerType.spatial_files">[docs]</a>
    <span class="n">spatial_files</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span></div>

<div class="viewcode-block" id="SpatialFilesLayerType.dataset_type">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.SpatialFilesLayerType.dataset_type">[docs]</a>
    <span class="n">dataset_type</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="get_spatial_files_dataset_type">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_spatial_files_dataset_type">[docs]</a>
<span class="k">def</span> <span class="nf">get_spatial_files_dataset_type</span><span class="p">(</span><span class="n">allowed_extensions</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialFilesLayerType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reutnrs &#39;vector&#39; or &#39;raster&#39; whether a file from the allowed extensins has been identified.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">geonode.upload.files</span> <span class="kn">import</span> <span class="n">scan_file</span>

    <span class="n">allowed_file</span> <span class="o">=</span> <span class="n">select_relevant_files</span><span class="p">(</span><span class="n">allowed_extensions</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_file</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">allowed_file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">base_file</span> <span class="o">=</span> <span class="n">allowed_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spatial_files</span> <span class="o">=</span> <span class="n">scan_file</span><span class="p">(</span><span class="n">base_file</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="n">charset</span><span class="p">)</span>
    <span class="n">the_dataset_type</span> <span class="o">=</span> <span class="n">get_dataset_type</span><span class="p">(</span><span class="n">spatial_files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">the_dataset_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FeatureType</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">Coverage</span><span class="o">.</span><span class="n">resource_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">spatial_files_type</span> <span class="o">=</span> <span class="n">SpatialFilesLayerType</span><span class="p">(</span>
        <span class="n">base_file</span><span class="o">=</span><span class="n">base_file</span><span class="p">,</span>
        <span class="n">scan_hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">spatial_files</span><span class="o">=</span><span class="n">spatial_files</span><span class="p">,</span>
        <span class="n">dataset_type</span><span class="o">=</span><span class="s2">&quot;vector&quot;</span> <span class="k">if</span> <span class="n">the_dataset_type</span> <span class="o">==</span> <span class="n">FeatureType</span><span class="o">.</span><span class="n">resource_type</span> <span class="k">else</span> <span class="s2">&quot;raster&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">spatial_files_type</span></div>



<div class="viewcode-block" id="get_dataset_type">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_dataset_type">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataset_type</span><span class="p">(</span><span class="n">spatial_files</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns &#39;FeatureType.resource_type&#39; or &#39;Coverage.resource_type&#39; accordingly to the provided SpatialFiles&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spatial_files</span><span class="o">.</span><span class="n">archive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">the_dataset_type</span> <span class="o">=</span> <span class="n">FeatureType</span><span class="o">.</span><span class="n">resource_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">the_dataset_type</span> <span class="o">=</span> <span class="n">spatial_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">file_type</span><span class="o">.</span><span class="n">dataset_type</span>
    <span class="k">return</span> <span class="n">the_dataset_type</span></div>



<div class="viewcode-block" id="get_dataset_capabilities_url">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_dataset_capabilities_url">[docs]</a>
<span class="k">def</span> <span class="nf">get_dataset_capabilities_url</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.3.0&quot;</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the layer-specific GetCapabilities URL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_layername</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
    <span class="n">wms_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GEOSERVER_PUBLIC_LOCATION</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="p">:</span>
        <span class="n">wms_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wms_url</span><span class="si">}{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_layername</span><span class="p">)</span><span class="si">}</span><span class="s2">/ows?service=wms&amp;version=</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&amp;request=GetCapabilities&quot;</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="n">access_token</span><span class="p">:</span>
            <span class="n">wms_url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&amp;access_token=</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wms_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">service_url</span><span class="si">}</span><span class="s2">?service=wms&amp;version=</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&amp;request=GetCapabilities&quot;</span>

    <span class="k">return</span> <span class="n">wms_url</span></div>



<div class="viewcode-block" id="get_layer_ows_url">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.get_layer_ows_url">[docs]</a>
<span class="k">def</span> <span class="nf">get_layer_ows_url</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the layer-specific GetCapabilities URL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace_layername</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
    <span class="n">ows_url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GEOSERVER_PUBLIC_LOCATION</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="p">:</span>
        <span class="n">ows_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ows_url</span><span class="si">}{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_layername</span><span class="p">)</span><span class="si">}</span><span class="s2">/ows&quot;</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="n">access_token</span><span class="p">:</span>
            <span class="n">ows_url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;?access_token=</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ows_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">remote_service</span><span class="o">.</span><span class="n">service_url</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">ows_url</span></div>



<div class="viewcode-block" id="wps_format_is_supported">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.wps_format_is_supported">[docs]</a>
<span class="k">def</span> <span class="nf">wps_format_is_supported</span><span class="p">(</span><span class="n">_format</span><span class="p">,</span> <span class="n">dataset_type</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">_format</span><span class="p">,</span> <span class="n">dataset_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">WPS_ACCEPTABLE_FORMATS</span></div>



<div class="viewcode-block" id="ows_endpoint_in_path">
<a class="viewcode-back" href="../../../autoapi/geonode/geoserver/helpers/index.html#geonode.geoserver.helpers.ows_endpoint_in_path">[docs]</a>
<span class="k">def</span> <span class="nf">ows_endpoint_in_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*(?&lt;!rest)/(rest)/.*$&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*(?&lt;!w[a-z]s)/(w.*s)/.*$&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*(?&lt;!ows)/(ows)/.*$&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kan Territory &amp; IT.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>