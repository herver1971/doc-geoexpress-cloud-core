

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geonode.harvesting.api.serializers &mdash; GeoNode Cloud Core 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            GeoNode Cloud Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">GeoNode Cloud Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../geonode.html">geonode</a></li>
          <li class="breadcrumb-item"><a href="../../harvesting.html">geonode.harvesting</a></li>
      <li class="breadcrumb-item active">geonode.harvesting.api.serializers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geonode.harvesting.api.serializers</h1><div class="highlight"><pre>
<span></span><span class="c1">#########################################################################</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2021 OSGeo</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">#########################################################################</span>

<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">jsonschema.exceptions</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">dynamic_rest.serializers</span> <span class="kn">import</span> <span class="n">DynamicModelSerializer</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">DjangoValidationError</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">exceptions</span><span class="p">,</span>
    <span class="n">serializers</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">rest_framework.fields</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_error_detail</span><span class="p">,</span>
    <span class="n">set_value</span><span class="p">,</span>
    <span class="n">SkipField</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">rest_framework.reverse</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">rest_framework.settings</span> <span class="kn">import</span> <span class="n">api_settings</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">models</span><span class="p">,</span>
    <span class="n">tasks</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>



<div class="viewcode-block" id="CurrentUserDefault">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.CurrentUserDefault">[docs]</a>
<span class="k">class</span> <span class="nc">CurrentUserDefault</span><span class="p">:</span>
<div class="viewcode-block" id="CurrentUserDefault.requires_context">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.CurrentUserDefault.requires_context">[docs]</a>
    <span class="n">requires_context</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CurrentUserDefault.__call__">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.CurrentUserDefault.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer_field</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">serializer_field</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">user</span></div>
</div>



<div class="viewcode-block" id="BriefHarvesterSerializer">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer">[docs]</a>
<span class="k">class</span> <span class="nc">BriefHarvesterSerializer</span><span class="p">(</span><span class="n">DynamicModelSerializer</span><span class="p">):</span>
<div class="viewcode-block" id="BriefHarvesterSerializer.Meta">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.Meta">[docs]</a>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<div class="viewcode-block" id="BriefHarvesterSerializer.Meta.model">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.Meta.model">[docs]</a>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span></div>

<div class="viewcode-block" id="BriefHarvesterSerializer.Meta.fields">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.Meta.fields">[docs]</a>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_available&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scheduling_enabled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;harvesting_session_update_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;refresh_harvestable_resources_update_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_availability_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default_owner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="BriefHarvesterSerializer.default_owner">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.default_owner">[docs]</a>
    <span class="n">default_owner</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span>
        <span class="n">queryset</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">CurrentUserDefault</span><span class="p">(),</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="BriefHarvesterSerializer.links">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.links">[docs]</a>
    <span class="n">links</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span></div>


<div class="viewcode-block" id="BriefHarvesterSerializer.get_links">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefHarvesterSerializer.get_links">[docs]</a>
    <span class="k">def</span> <span class="nf">get_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span>
                <span class="s2">&quot;harvester-detail&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="s2">&quot;harvestable_resources&quot;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span>
                <span class="s2">&quot;harvestable-resources-list&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;harvester_id&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="HarvesterSerializer">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer">[docs]</a>
<span class="k">class</span> <span class="nc">HarvesterSerializer</span><span class="p">(</span><span class="n">BriefHarvesterSerializer</span><span class="p">):</span>
<div class="viewcode-block" id="HarvesterSerializer.Meta">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.Meta">[docs]</a>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<div class="viewcode-block" id="HarvesterSerializer.Meta.model">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.Meta.model">[docs]</a>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span></div>

<div class="viewcode-block" id="HarvesterSerializer.Meta.fields">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.Meta.fields">[docs]</a>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_available&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scheduling_enabled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check_availability_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;harvesting_session_update_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;refresh_harvestable_resources_update_frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default_owner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;harvester_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;harvester_type_specific_configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_checked_availability&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_checked_harvestable_resources&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_check_harvestable_resources_message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;harvest_new_resources_by_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delete_orphan_resources_automatically&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="HarvesterSerializer.validate">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.validate">[docs]</a>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform object-level validation</span>

<span class="sd">        In this method we implement validation of the following:</span>

<span class="sd">        - Check that the worker configuration is valid for the current worker type.</span>
<span class="sd">          This is done by validating the config against the worker&#39;s extra config jsonschema (if it exists)</span>

<span class="sd">        - Check that the client does not try to change the object&#39;s and worker config at the same time, as that could lead to invalid internal state (for example, if the worker config changes we need to regenerate the list of harvestable resources before allowing a new harvesting session to take place).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">worker_config_field</span> <span class="o">=</span> <span class="s2">&quot;harvester_type_specific_configuration&quot;</span>
        <span class="n">worker_type_field</span> <span class="o">=</span> <span class="s2">&quot;harvester_type&quot;</span>
        <span class="n">worker_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_type_field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">worker_type_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">worker_config</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_config_field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">worker_config_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">worker_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">worker_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">validate_worker_configuration</span><span class="p">(</span><span class="n">worker_type</span><span class="p">,</span> <span class="n">worker_config</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">worker_config_field</span><span class="si">!r}</span><span class="s2"> configuration&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_config_field</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot update a harvester&#39;s &#39;status&#39; and </span><span class="si">{</span><span class="n">worker_config_field</span><span class="si">!r}</span><span class="s2"> at &quot;</span> <span class="sa">f</span><span class="s2">&quot;the same time&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="HarvesterSerializer.create">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">desired_status</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desired_status</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid initial value for status: </span><span class="si">{</span><span class="n">desired_status</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Either omit it or provide a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;value of </span><span class="si">{</span><span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">validated_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="HarvesterSerializer.update">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvesterSerializer.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update harvester and perform any required business logic as a side-effect.</span>

<span class="sd">        Updating the harvester&#39;s `status` attribute triggers additional work:</span>

<span class="sd">        - If `status` is set to `models.Harvester.STATUS_UPDATING_HARVESTABLE_RESOURCES`, then we proceed to refresh all harvestable resources related to the harvester</span>

<span class="sd">        - If `status` is set to `models.Harvester.STATUS_PERFORM_HARVESTING` then we proceed by starting a new harvesting session</span>

<span class="sd">        - If `status` is set to `models.Harvester.STATUS_CHECKING_AVAILABILITY` then we proceed to check the availability of the remote service</span>

<span class="sd">        Note that it is not possible for an API client to set a status of `models.Harvester.STATUS_READY`. This status is set internally.</span>

<span class="sd">        Additional work can also be triggered when a change to the harvester worker configuration is requested. In that case GeoNode must regenerate the list of harvestable resources.</span>

<span class="sd">        Also note that all of these additional work items are carried out asynchronously via celery tasks.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">desired_status</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Harvester is currently busy. Please wait until current &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;status becomes </span><span class="si">{</span><span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">desired_status</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot set a status of </span><span class="si">{</span><span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="si">!r}</span><span class="s2"> explicitly. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This status can only be set by the server, when appropriate.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">desired_status</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_UPDATING_HARVESTABLE_RESOURCES</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AsynchronousHarvestingSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">harvester</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                <span class="n">session_type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">AsynchronousHarvestingSession</span><span class="o">.</span><span class="n">TYPE_DISCOVER_HARVESTABLE_RESOURCES</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">post_update_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">update_harvestable_resources</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">pk</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="n">desired_status</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_PERFORMING_HARVESTING</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AsynchronousHarvestingSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">harvester</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">session_type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">AsynchronousHarvestingSession</span><span class="o">.</span><span class="n">TYPE_HARVESTING</span>
            <span class="p">)</span>
            <span class="n">post_update_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">harvesting_dispatcher</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">pk</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="n">desired_status</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">STATUS_CHECKING_AVAILABILITY</span><span class="p">:</span>
            <span class="n">post_update_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">check_harvester_available</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="n">desired_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_worker_config</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">harvester_type_specific_configuration</span>
            <span class="n">desired_worker_config</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;harvester_type_specific_configuration&quot;</span><span class="p">,</span> <span class="n">current_worker_config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">desired_worker_config</span> <span class="o">!=</span> <span class="n">current_worker_config</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regenerating harvestable resource list for harvester &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">!r}</span><span class="s2"> asynchronously...&quot;</span><span class="p">)</span>
                <span class="n">models</span><span class="o">.</span><span class="n">HarvestableResource</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">harvester</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">post_update_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">update_harvestable_resources</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_update_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_update_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">updated_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">post_update_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">post_update_task</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">expiration</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated_instance</span></div>
</div>



<div class="viewcode-block" id="BriefAsynchronousHarvestingSessionSerializer">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefAsynchronousHarvestingSessionSerializer">[docs]</a>
<span class="k">class</span> <span class="nc">BriefAsynchronousHarvestingSessionSerializer</span><span class="p">(</span><span class="n">DynamicModelSerializer</span><span class="p">):</span>
<div class="viewcode-block" id="BriefAsynchronousHarvestingSessionSerializer.Meta">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefAsynchronousHarvestingSessionSerializer.Meta">[docs]</a>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<div class="viewcode-block" id="BriefAsynchronousHarvestingSessionSerializer.Meta.model">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefAsynchronousHarvestingSessionSerializer.Meta.model">[docs]</a>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AsynchronousHarvestingSession</span></div>

<div class="viewcode-block" id="BriefAsynchronousHarvestingSessionSerializer.Meta.fields">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.BriefAsynchronousHarvestingSessionSerializer.Meta.fields">[docs]</a>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;started&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ended&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_records_to_process&quot;</span><span class="p">,</span>
            <span class="s2">&quot;records_done&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>
</div>



<div class="viewcode-block" id="HarvestableResourceSerializer">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer">[docs]</a>
<span class="k">class</span> <span class="nc">HarvestableResourceSerializer</span><span class="p">(</span><span class="n">DynamicModelSerializer</span><span class="p">):</span>
<div class="viewcode-block" id="HarvestableResourceSerializer.Meta">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.Meta">[docs]</a>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<div class="viewcode-block" id="HarvestableResourceSerializer.Meta.model">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.Meta.model">[docs]</a>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">HarvestableResource</span></div>

<div class="viewcode-block" id="HarvestableResourceSerializer.Meta.fields">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.Meta.fields">[docs]</a>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;unique_identifier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">,</span>
            <span class="s2">&quot;should_be_harvested&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_resource_type&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="HarvestableResourceSerializer.Meta.read_only_fields">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.Meta.read_only_fields">[docs]</a>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;title&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remote_resource_type&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>
</div>


<div class="viewcode-block" id="HarvestableResourceSerializer.create">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="c1"># NOTE: We are implementing `create()` rather than `update` intentionally, even if the</span>
        <span class="c1"># user is not allowed to create new records (check the `views.py` module) - the rationale</span>
        <span class="c1"># being that since we keep a harvestable_resource&#39;s `id` private it would be more involved</span>
        <span class="c1"># to deal with its update than with its creation. We are providing a custom `UpdateListModelMixin` class</span>
        <span class="c1"># that allows for bulk update of multiple instances simultaneously. This mixin class is instantiating</span>
        <span class="c1"># this serializer class without providing an instance and then calling its `save()` method</span>
        <span class="n">harvestable_resource</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">HarvestableResource</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">harvester</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;harvester&quot;</span><span class="p">],</span> <span class="n">unique_identifier</span><span class="o">=</span><span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;unique_identifier&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">harvestable_resource</span><span class="o">.</span><span class="n">should_be_harvested</span> <span class="o">=</span> <span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;should_be_harvested&quot;</span><span class="p">]</span>
        <span class="n">harvestable_resource</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">harvestable_resource</span></div>


    <span class="c1"># TODO: need to check whether any worker-specific configuration has changed when the harvester is updated</span>
    <span class="c1"># if so, then we need to discard existing harvestable_resources and check them again</span>

<div class="viewcode-block" id="HarvestableResourceSerializer.to_internal_value">
<a class="viewcode-back" href="../../../../autoapi/geonode/harvesting/api/serializers/index.html#geonode.harvesting.api.serializers.HarvestableResourceSerializer.to_internal_value">[docs]</a>
    <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verbatim copy of the original drf `to_internal_value()` method.</span>

<span class="sd">        This method replicates the implementation found on `restframework.serializers.Serializer.to_internal_value` method because the dynamic-rest package (which we are using, and which overrides the base implementation) adds some custom stuff on top of it which depends on the input data containing the instance&#39;s `id` property, which we are not requiring.</span>

<span class="sd">        A HarvestableResource&#39;s `id` is an implementation detail that is not exposed publicly. We rely on the instance&#39;s `unique_identifier` instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_messages</span><span class="p">[</span><span class="s2">&quot;invalid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datatype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">({</span><span class="n">api_settings</span><span class="o">.</span><span class="n">NON_FIELD_ERRORS_KEY</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">]},</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writable_fields</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">validate_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;validate_</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">primitive_value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">validated_value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">run_validation</span><span class="p">(</span><span class="n">primitive_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validate_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">validated_value</span> <span class="o">=</span> <span class="n">validate_method</span><span class="p">(</span><span class="n">validated_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span>
            <span class="k">except</span> <span class="n">DjangoValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_error_detail</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SkipField</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">set_value</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">source_attrs</span><span class="p">,</span> <span class="n">validated_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kan Territory &amp; IT.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>