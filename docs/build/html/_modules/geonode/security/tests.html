

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geonode.security.tests &mdash; GeoNode Cloud Core 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            GeoNode Cloud Core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenido</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">GeoNode Cloud Core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../geonode.html">geonode</a></li>
          <li class="breadcrumb-item"><a href="../security.html">geonode.security</a></li>
      <li class="breadcrumb-item active">geonode.security.tests</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geonode.security.tests</h1><div class="highlight"><pre>
<span></span><span class="c1">#########################################################################</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2016 OSGeo</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">#########################################################################</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">mock</span>

<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">from</span> <span class="nn">tastypie.test</span> <span class="kn">import</span> <span class="n">ResourceTestCaseMixin</span>

<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span> <span class="nn">django.test.testcases</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">override_settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AnonymousUser</span>

<span class="kn">from</span> <span class="nn">guardian.shortcuts</span> <span class="kn">import</span> <span class="n">assign_perm</span><span class="p">,</span> <span class="n">get_anonymous_user</span>

<span class="kn">from</span> <span class="nn">geonode</span> <span class="kn">import</span> <span class="n">geoserver</span>
<span class="kn">from</span> <span class="nn">geonode.geoserver.helpers</span> <span class="kn">import</span> <span class="n">geofence</span><span class="p">,</span> <span class="n">gf_utils</span>
<span class="kn">from</span> <span class="nn">geonode.maps.models</span> <span class="kn">import</span> <span class="n">Map</span>
<span class="kn">from</span> <span class="nn">geonode.layers.models</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">geonode.documents.models</span> <span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">geonode.compat</span> <span class="kn">import</span> <span class="n">ensure_string</span>
<span class="kn">from</span> <span class="nn">geonode.utils</span> <span class="kn">import</span> <span class="n">check_ogc_backend</span>
<span class="kn">from</span> <span class="nn">geonode.tests.utils</span> <span class="kn">import</span> <span class="n">check_dataset</span>
<span class="kn">from</span> <span class="nn">geonode.decorators</span> <span class="kn">import</span> <span class="n">on_ogc_backend</span>
<span class="kn">from</span> <span class="nn">geonode.resource.manager</span> <span class="kn">import</span> <span class="n">resource_manager</span>
<span class="kn">from</span> <span class="nn">geonode.tests.base</span> <span class="kn">import</span> <span class="n">GeoNodeBaseTestSupport</span>
<span class="kn">from</span> <span class="nn">geonode.groups.models</span> <span class="kn">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">GroupMember</span><span class="p">,</span> <span class="n">GroupProfile</span>
<span class="kn">from</span> <span class="nn">geonode.layers.populate_datasets_data</span> <span class="kn">import</span> <span class="n">create_dataset_data</span>
<span class="kn">from</span> <span class="nn">geonode.base.auth</span> <span class="kn">import</span> <span class="n">create_auth_token</span><span class="p">,</span> <span class="n">get_or_create_token</span>

<span class="kn">from</span> <span class="nn">geonode.base.models</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">UserGeoLimit</span><span class="p">,</span> <span class="n">GroupGeoLimit</span>
<span class="kn">from</span> <span class="nn">geonode.base.populate_test_data</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">all_public</span><span class="p">,</span>
    <span class="n">create_models</span><span class="p">,</span>
    <span class="n">create_single_doc</span><span class="p">,</span>
    <span class="n">create_single_map</span><span class="p">,</span>
    <span class="n">remove_models</span><span class="p">,</span>
    <span class="n">create_single_dataset</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">geonode.geoserver.security</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_get_gf_services</span><span class="p">,</span>
    <span class="n">allow_layer_to_all</span><span class="p">,</span>
    <span class="n">delete_all_acl_rules</span><span class="p">,</span>
    <span class="n">sync_resources_with_guardian</span><span class="p">,</span>
    <span class="n">_get_gwc_filters_and_formats</span><span class="p">,</span>
    <span class="n">has_geolimits</span><span class="p">,</span>
    <span class="n">create_geofence_rules</span><span class="p">,</span>
    <span class="n">delete_acl_rules_for_layer</span><span class="p">,</span>
<span class="p">)</span>


<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_users_with_perms</span><span class="p">,</span>
    <span class="n">get_visible_resources</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.permissions</span> <span class="kn">import</span> <span class="n">PermSpec</span><span class="p">,</span> <span class="n">PermSpecCompact</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>



<div class="viewcode-block" id="_log">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests._log">[docs]</a>
<span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>



<div class="viewcode-block" id="StreamToLogger">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.StreamToLogger">[docs]</a>
<span class="k">class</span> <span class="nc">StreamToLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fake file-like stream object that redirects writes to a logger instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
<div class="viewcode-block" id="StreamToLogger.logger">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.StreamToLogger.logger">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span></div>

<div class="viewcode-block" id="StreamToLogger.log_level">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.StreamToLogger.log_level">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span></div>

<div class="viewcode-block" id="StreamToLogger.linebuf">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.StreamToLogger.linebuf">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">linebuf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="StreamToLogger.write">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.StreamToLogger.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">buf</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="SecurityTests">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests">[docs]</a>
<span class="k">class</span> <span class="nc">SecurityTests</span><span class="p">(</span><span class="n">ResourceTestCaseMixin</span><span class="p">,</span> <span class="n">GeoNodeBaseTestSupport</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for the Geonode security app.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SecurityTests.setUpClass">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.setUpClass">[docs]</a>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="n">create_models</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_type</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_integration</span><span class="p">)</span>
        <span class="n">all_public</span><span class="p">()</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SecurityTests.tearDownClass">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.tearDownClass">[docs]</a>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>
        <span class="n">remove_models</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_obj_ids</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_type</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_integration</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;ACL_SECURITY_ENABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
        <span class="n">create_dataset_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span> <span class="o">=</span> <span class="n">get_anonymous_user</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;api_dispatch_list&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api_name&quot;</span><span class="p">:</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="s2">&quot;resource_name&quot;</span><span class="p">:</span> <span class="s2">&quot;datasets&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_perms_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;bulk_permissions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_login_middleware">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_login_middleware">[docs]</a>
    <span class="k">def</span> <span class="nf">test_login_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the Geonode login required authentication middleware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">geonode.security.middleware</span> <span class="kn">import</span> <span class="n">LoginRequiredMiddleware</span>

        <span class="n">middleware</span> <span class="o">=</span> <span class="n">LoginRequiredMiddleware</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">white_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_ajax_login&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_confirm_email&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_login&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_reset_password&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;forgot_username&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_acls&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_resolve_user&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">black_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_signup&quot;</span><span class="p">),</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;profile_browse&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_anonymous_user</span><span class="p">()</span>

        <span class="c1"># Requests should be redirected to the the `redirected_to` path when un-authenticated user attempts to visit</span>
        <span class="c1"># a black-listed url.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">black_list</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">middleware</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">))</span>

        <span class="c1"># The middleware should return None when an un-authenticated user</span>
        <span class="c1"># attempts to visit a white-listed url.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">white_list</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Middleware activated for white listed path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>

        <span class="c1"># The middleware should return None when an authenticated user attempts</span>
        <span class="c1"># to visit a black-listed url.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">black_list</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_login_middleware_with_basic_auth">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_login_middleware_with_basic_auth">[docs]</a>
    <span class="k">def</span> <span class="nf">test_login_middleware_with_basic_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the Geonode login required authentication middleware with Basic authenticated queries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">geonode.security.middleware</span> <span class="kn">import</span> <span class="n">LoginRequiredMiddleware</span>

        <span class="n">middleware</span> <span class="o">=</span> <span class="n">LoginRequiredMiddleware</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">black_listed_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_upload&quot;</span><span class="p">)</span>
        <span class="n">white_listed_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_login&quot;</span><span class="p">)</span>

        <span class="c1"># unauthorized request to black listed URL should be redirected to `redirect_to` URL</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_anonymous_user</span><span class="p">()</span>

        <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">black_listed_url</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">middleware</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">))</span>

        <span class="c1"># unauthorized request to white listed URL should be allowed</span>
        <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">white_listed_url</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Middleware activated for white listed path: </span><span class="si">{</span><span class="n">black_listed_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Basic authorized request to black listed URL should be allowed</span>
        <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">black_listed_url</span>
        <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Basic </span><span class="si">{</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;bobby:bob&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Middleware activated for white listed path: </span><span class="si">{</span><span class="n">black_listed_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_login_middleware_with_custom_login_url">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_login_middleware_with_custom_login_url">[docs]</a>
    <span class="k">def</span> <span class="nf">test_login_middleware_with_custom_login_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the Geonode login required authentication middleware with Basic authenticated queries</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">site_url_settings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SITEURL</span><span class="si">}</span><span class="s2">login/custom&quot;</span><span class="p">,</span> <span class="s2">&quot;/login/custom&quot;</span><span class="p">,</span> <span class="s2">&quot;login/custom&quot;</span><span class="p">]</span>
        <span class="n">black_listed_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_upload&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">site_url_settings</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">override_settings</span><span class="p">(</span><span class="n">LOGIN_URL</span><span class="o">=</span><span class="n">setting</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">geonode.security</span> <span class="kn">import</span> <span class="n">middleware</span> <span class="k">as</span> <span class="n">mw</span>

                <span class="c1"># reload the middleware module to fetch overridden settings</span>
                <span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mw</span><span class="p">)</span>
                <span class="n">middleware</span> <span class="o">=</span> <span class="n">mw</span><span class="o">.</span><span class="n">LoginRequiredMiddleware</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1"># unauthorized request to black listed URL should be redirected to `redirect_to` URL</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
                <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">AnonymousUser</span><span class="p">()</span>
                <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">black_listed_url</span>

                <span class="n">response</span> <span class="o">=</span> <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;Middleware didn&#39;t activate for blacklisted URL.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Returned redirection should be a valid path starting &#39;/&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Instead got: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_session_ctrl_middleware">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_session_ctrl_middleware">[docs]</a>
    <span class="k">def</span> <span class="nf">test_session_ctrl_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the Geonode session control authentication middleware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">geonode.security.middleware</span> <span class="kn">import</span> <span class="n">SessionControlMiddleware</span>
        <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_ENGINE</span><span class="p">)</span>
        <span class="n">middleware</span> <span class="o">=</span> <span class="n">SessionControlMiddleware</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">admin</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">SessionStore</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_or_create_token</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">is_empty</span><span class="p">())</span>

        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">is_empty</span><span class="p">())</span>

        <span class="c1"># Test the full cycle through the client</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;account_email&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Simulating Token expired (or not set)</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_COOKIE_NAME</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">SessionStore</span><span class="p">(</span><span class="n">session_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_attributes_sats_refresh">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_attributes_sats_refresh">[docs]</a>
    <span class="k">def</span> <span class="nf">test_attributes_sats_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">dataset_attributes</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">dataset_attributes</span><span class="p">)</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">attribute_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">uuid</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;attributes_sats_refresh&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertHttpOK</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dataset_attributes</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

            <span class="kn">from</span> <span class="nn">geonode.geoserver.helpers</span> <span class="kn">import</span> <span class="n">set_attributes_from_geoserver</span>

            <span class="n">test_dataset</span><span class="o">.</span><span class="n">attribute_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">set_attributes_from_geoserver</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dataset_attributes</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

            <span class="c1"># Remove permissions to anonymous users and try to refresh attributes again</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">attribute_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">set_attributes_from_geoserver</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dataset_attributes</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If GeoServer is unreachable, this view now returns a 302 error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_invalidate_tileddataset_cache">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_invalidate_tileddataset_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">test_invalidate_tileddataset_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">uuid</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;invalidate_tileddataset_cache&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertHttpOK</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_set_bulk_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_set_bulk_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_set_bulk_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that after restrict view permissions on two layers</span>
<span class="sd">        bobby is unable to see them&quot;&quot;&quot;</span>

        <span class="n">rules_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">delete_all_acl_rules</span><span class="p">()</span>
            <span class="c1"># Reset GeoFence Rules</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">layers_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
        <span class="n">test_perm_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">resp</span><span class="p">)[</span><span class="s2">&quot;objects&quot;</span><span class="p">]),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">),</span> <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="n">layers_id</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_perms_url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertHttpOK</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="c1"># Check GeoFence Rules have been correctly created</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">allow_layer_to_all</span><span class="p">(</span><span class="n">test_perm_dataset</span><span class="p">)</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">resp</span><span class="p">)[</span><span class="s2">&quot;objects&quot;</span><span class="p">]),</span> <span class="mi">6</span><span class="p">)</span>

            <span class="c1"># perms = get_users_with_perms(test_perm_dataset)</span>
            <span class="c1"># _log(f&quot;3. perms: {perms} &quot;)</span>
            <span class="c1"># batch = AutoPriorityBatch(get_first_available_priority(), f&#39;test batch for {test_perm_dataset}&#39;)</span>
            <span class="c1"># for u, p in perms.items():</span>
            <span class="c1">#     create_geofence_rules(test_perm_dataset, p, user=u, batch=batch)</span>
            <span class="c1"># geofence.run_batch(batch)</span>

            <span class="c1"># Check GeoFence Rules have been correctly created</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

            <span class="c1"># Validate maximum priority</span>
            <span class="n">available_priority</span> <span class="o">=</span> <span class="n">gf_utils</span><span class="o">.</span><span class="n">get_first_available_priority</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;5. available_priority: </span><span class="si">{</span><span class="n">available_priority</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">available_priority</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;LOCATION&quot;</span><span class="p">]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;USER&quot;</span><span class="p">]</span>
            <span class="n">passwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">]</span>

            <span class="n">test_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">gwc/rest/seed/</span><span class="si">{</span><span class="n">test_perm_dataset</span><span class="o">.</span><span class="n">alternate</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">passwd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GWC error for user: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> URL: </span><span class="si">{</span><span class="n">test_url</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">rules_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">delete_all_acl_rules</span><span class="p">()</span>
            <span class="c1"># Reset GeoFence Rules</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_bobby_cannot_set_all">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_bobby_cannot_set_all">[docs]</a>
    <span class="k">def</span> <span class="nf">test_bobby_cannot_set_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that Bobby can set the permissions only on the ones</span>
<span class="sd">        for which he has the right&quot;&quot;&quot;</span>
        <span class="n">bobby</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bobby</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="c1"># give bobby the right to change the layer permissions</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span> <span class="n">bobby</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">)</span>
        <span class="n">layer2</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bobby</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}),</span>
            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">layer2</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_perms_url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;not_changed&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">layer2</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;not_changed&quot;</span><span class="p">])</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_user_can">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_user_can">[docs]</a>
    <span class="k">def</span> <span class="nf">test_user_can</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bobby</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="c1"># Test user has permission with read_only=False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_can</span><span class="p">(</span><span class="n">bobby</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">))</span>
        <span class="c1"># Test with edit permission and read_only=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_can</span><span class="p">(</span><span class="n">bobby</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">))</span>
        <span class="c1"># Test with view permission and read_only=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_can</span><span class="p">(</span><span class="n">bobby</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">))</span>
        <span class="c1"># Test on a &#39;raster&#39; subtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;raster&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="c1"># Test user has permission with read_only=False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_can</span><span class="p">(</span><span class="n">bobby</span><span class="p">,</span> <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_can</span><span class="p">(</span><span class="n">bobby</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">))</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_perm_specs_synchronization">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_perm_specs_synchronization">[docs]</a>
    <span class="k">def</span> <span class="nf">test_perm_specs_synchronization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that Dataset is correctly synchronized with guardian:</span>
<span class="sd">        1. Set permissions to all users</span>
<span class="sd">        2. Set permissions to a single user</span>
<span class="sd">        3. Set permissions to a group of users</span>
<span class="sd">        4. Try to sync a layer from GeoServer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bobby</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bobby</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>

        <span class="c1"># Reset GeoFence Rules</span>
        <span class="n">delete_all_acl_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bad rules count. Got rules: </span><span class="si">{</span><span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_dataset_data&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bad rules count. Got rules: </span><span class="si">{</span><span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="n">wps_subfield_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WPS&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;subfield&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GS:DOWNLOAD&quot;</span><span class="p">:</span>
                <span class="n">wps_subfield_found</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">wps_subfield_found</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;WPS download not blocked. Got rules: </span><span class="si">{</span><span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># FULL WFS-T</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WFS&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRANSACTION&quot;</span><span class="p">:</span>
                <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_deny_wfst_rule_exists</span><span class="p">)</span>

        <span class="c1"># NO WFS-T</span>
        <span class="c1"># - order is important</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_deny_wfst_rule_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">_allow_wfs_rule_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WFS&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRANSACTION&quot;</span><span class="p">:</span>
                <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
                <span class="n">_deny_wfst_rule_position</span> <span class="o">=</span> <span class="n">cnt</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WFS&quot;</span>
                <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">_allow_wfs_rule_position</span> <span class="o">=</span> <span class="n">cnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_deny_wfst_rule_exists</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_allow_wfs_rule_position</span> <span class="o">&gt;</span> <span class="n">_deny_wfst_rule_position</span><span class="p">)</span>

        <span class="c1"># NO WFS</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WFS&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TRANSACTION&quot;</span><span class="p">:</span>
                <span class="n">_deny_wfst_rule_exists</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DENY&quot;</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_deny_wfst_rule_exists</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]}}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;4. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bad rule count, got rules </span><span class="si">{</span><span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]}}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;5. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Testing GeoLimits</span>
        <span class="c1"># Reset GeoFence Rules</span>
        <span class="n">delete_all_acl_rules</span><span class="p">()</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># grab bobby</span>
        <span class="n">bobby</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">filters</span><span class="p">,</span> <span class="n">formats</span> <span class="o">=</span> <span class="n">_get_gwc_filters_and_formats</span><span class="p">(</span><span class="n">_disable_dataset_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="p">[{</span><span class="s2">&quot;styleParameterFilter&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;STYLES&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}}])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span>
            <span class="n">formats</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;application/json;type=utfgrid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/gif&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/png8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/vnd.jpeg-png&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image/vnd.jpeg-png8&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">geo_limit</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">UserGeoLimit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">bobby</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">())</span>
        <span class="n">geo_limit</span><span class="o">.</span><span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;SRID=4326;MULTIPOLYGON (((145.8046418749977 -42.49606500060302, </span><span class="se">\</span>
<span class="s2">146.7000276171853 -42.53655428642583, 146.7110139453067 -43.07256577359489, </span><span class="se">\</span>
<span class="s2">145.9804231249952 -43.05651288026286, 145.8046418749977 -42.49606500060302)))&quot;</span>
        <span class="n">geo_limit</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">users_geolimits</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">geo_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">users_geolimits</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">bobby</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">filters</span><span class="p">,</span> <span class="n">formats</span> <span class="o">=</span> <span class="n">_get_gwc_filters_and_formats</span><span class="p">([</span><span class="n">_disable_dataset_cache</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">formats</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Order is important</span>
        <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">],</span> <span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">],</span> <span class="s2">&quot;geonode&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">],</span> <span class="s2">&quot;CA&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">],</span> <span class="s2">&quot;LIMIT&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
                <span class="n">rule_limits</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                    <span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;allowedArea&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;SRID=4326;MULTIPOLYGON (((145.8046418749977 -42.49606500060302, </span><span class="se">\</span>
<span class="s2">146.7000276171853 -42.53655428642583, 146.7110139453067 -43.07256577359489, </span><span class="se">\</span>
<span class="s2">145.9804231249952 -43.05651288026286, 145.8046418749977 -42.49606500060302)))&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;catalogMode&quot;</span><span class="p">],</span> <span class="s2">&quot;MIXED&quot;</span><span class="p">)</span>
                <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="n">cnt</span>
            <span class="k">elif</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bobby&quot;</span><span class="p">:</span>
                <span class="c1"># When there&#39;s a limit rule, &quot;*&quot; must be the first one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_limit_rule_position</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>

        <span class="n">geo_limit</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">GroupGeoLimit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">group</span><span class="o">=</span><span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group__name</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">),</span> <span class="n">resource</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">geo_limit</span><span class="o">.</span><span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;SRID=4326;MULTIPOLYGON (((145.8046418749977 -42.49606500060302, </span><span class="se">\</span>
<span class="s2">146.7000276171853 -42.53655428642583, 146.7110139453067 -43.07256577359489, </span><span class="se">\</span>
<span class="s2">145.9804231249952 -43.05651288026286, 145.8046418749977 -42.49606500060302)))&quot;</span>
        <span class="n">geo_limit</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">groups_geolimits</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">geo_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">groups_geolimits</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]}}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]),</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># Order is important</span>
        <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;roleName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ROLE_BAR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">],</span> <span class="s2">&quot;geonode&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">],</span> <span class="s2">&quot;CA&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">],</span> <span class="s2">&quot;LIMIT&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
                    <span class="n">rule_limits</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;allowedArea&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;SRID=4326;MULTIPOLYGON (((145.8046418749977 -42.49606500060302, </span><span class="se">\</span>
<span class="s2">146.7000276171853 -42.53655428642583, 146.7110139453067 -43.07256577359489, </span><span class="se">\</span>
<span class="s2">145.9804231249952 -43.05651288026286, 145.8046418749977 -42.49606500060302)))&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;catalogMode&quot;</span><span class="p">],</span> <span class="s2">&quot;MIXED&quot;</span><span class="p">)</span>
                    <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="n">cnt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># When there&#39;s a limit rule, &quot;*&quot; must be the first one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_limit_rule_position</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>

        <span class="c1"># Change Dataset Type and SRID in order to force GeoFence allowed-area reprojection</span>
        <span class="n">_original_subtype</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span>
        <span class="n">_original_srid</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">srid</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="s2">&quot;raster&quot;</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">srid</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3857&quot;</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>

        <span class="n">rules_objs</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules</span><span class="p">()</span>
        <span class="c1"># Order is important</span>
        <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rules_objs</span><span class="p">[</span><span class="s2">&quot;rules&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;roleName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ROLE_BAR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;service&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;workspace&quot;</span><span class="p">],</span> <span class="s2">&quot;geonode&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">],</span> <span class="s2">&quot;CA&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">],</span> <span class="s2">&quot;LIMIT&quot;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">)</span>
                    <span class="n">rule_limits</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;allowedArea&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;SRID=4326;MULTIPOLYGON (((145.8046418749977 -42.49606500060302, 146.7000276171853 </span><span class="se">\</span>
<span class="s2">-42.53655428642583, 146.7110139453067 -43.07256577359489, 145.9804231249952 </span><span class="se">\</span>
<span class="s2">-43.05651288026286, 145.8046418749977 -42.49606500060302)))&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rule_limits</span><span class="p">[</span><span class="s2">&quot;catalogMode&quot;</span><span class="p">],</span> <span class="s2">&quot;MIXED&quot;</span><span class="p">)</span>
                    <span class="n">_limit_rule_position</span> <span class="o">=</span> <span class="n">cnt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># When there&#39;s a limit rule, &quot;*&quot; must be the first one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_limit_rule_position</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>

        <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">_original_subtype</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">srid</span> <span class="o">=</span> <span class="n">_original_srid</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Reset GeoFence Rules</span>
        <span class="n">delete_all_acl_rules</span><span class="p">()</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


    <span class="nd">@on_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_dataset_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_dataset_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_dataset_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test permissions on a layer</span>
        <span class="n">bobby</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="s2">&quot;san_andres_y_providencia_poi&quot;</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">resource_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bobby</span><span class="p">,</span> <span class="n">workspace</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_WORKSPACE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">ows_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">ptype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">sourcetype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,</span> <span class="s2">&quot;geonode:san_andres_y_providencia_poi&quot;</span><span class="p">)</span>

        <span class="c1"># Reset GeoFence Rules</span>
        <span class="n">delete_all_acl_rules</span><span class="p">()</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;san_andres_y_providencia_poi&quot;</span><span class="p">)</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bobby</span><span class="p">)</span>
        <span class="n">check_dataset</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;0. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Set the layer private for not authenticated users</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">GEOSERVER_LOCATION</span><span class="si">}</span><span class="s2">ows?&quot;</span>
            <span class="s2">&quot;LAYERS=geonode%3Asan_andres_y_providencia_poi&amp;STYLES=&quot;</span>
            <span class="s2">&quot;&amp;FORMAT=image</span><span class="si">%2F</span><span class="s2">png&amp;SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&quot;</span>
            <span class="s2">&quot;&amp;SRS=EPSG%3A4326&quot;</span>
            <span class="s2">&quot;&amp;BBOX=-81.394599749999,13.316009005566,&quot;</span>
            <span class="s2">&quot;-81.370560451855,13.372728455566&quot;</span>
            <span class="s2">&quot;&amp;WIDTH=217&amp;HEIGHT=512&quot;</span>
        <span class="p">)</span>

        <span class="c1"># test view_resourcebase permission on anonymous user</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">),</span> <span class="s2">&quot;application/vnd.ogc.se_xml;charset=UTF-8&quot;</span><span class="p">)</span>

        <span class="c1"># test WMS with authenticated user that has access to the Dataset</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;USER&quot;</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">OGC_SERVER</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">),</span> <span class="s2">&quot;image/png&quot;</span><span class="p">)</span>

        <span class="c1"># test WMS with authenticated user that has no view_resourcebase:</span>
        <span class="c1"># the layer should be not accessible</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;norman&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;norman&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;text/html;charset=utf-8&quot;</span><span class="p">)</span>

        <span class="c1"># test change_dataset_style</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">GEOSERVER_LOCATION</span><span class="si">}</span><span class="s2">rest/workspaces/geonode/styles/san_andres_y_providencia_poi.xml&quot;</span>
        <span class="n">sld</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s2">    &lt;sld:StyledLayerDescriptor xmlns:sld=&quot;http://www.opengis.net/sld&quot;</span>
<span class="s2">    xmlns:gml=&quot;http://www.opengis.net/gml&quot; xmlns:ogc=&quot;http://www.opengis.net/ogc&quot;</span>
<span class="s2">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; version=&quot;1.0.0&quot;</span>
<span class="s2">    xsi:schemaLocation=&quot;http://www.opengis.net/sld http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd&quot;&gt;</span>
<span class="s2">    &lt;sld:NamedLayer&gt;</span>
<span class="s2">        &lt;sld:Name&gt;geonode:san_andres_y_providencia_poi&lt;/sld:Name&gt;</span>
<span class="s2">        &lt;sld:UserStyle&gt;</span>
<span class="s2">            &lt;sld:Name&gt;san_andres_y_providencia_poi&lt;/sld:Name&gt;</span>
<span class="s2">            &lt;sld:Title&gt;san_andres_y_providencia_poi&lt;/sld:Title&gt;</span>
<span class="s2">            &lt;sld:IsDefault&gt;1&lt;/sld:IsDefault&gt;</span>
<span class="s2">            &lt;sld:FeatureTypeStyle&gt;</span>
<span class="s2">            &lt;sld:Rule&gt;</span>
<span class="s2">                &lt;sld:PointSymbolizer&gt;</span>
<span class="s2">                    &lt;sld:Graphic&gt;</span>
<span class="s2">                        &lt;sld:Mark&gt;</span>
<span class="s2">                        &lt;sld:Fill&gt;</span>
<span class="s2">                            &lt;sld:CssParameter name=&quot;fill&quot;&gt;#8A7700</span>
<span class="s2">                            &lt;/sld:CssParameter&gt;</span>
<span class="s2">                        &lt;/sld:Fill&gt;</span>
<span class="s2">                        &lt;sld:Stroke&gt;</span>
<span class="s2">                            &lt;sld:CssParameter name=&quot;stroke&quot;&gt;#bbffff</span>
<span class="s2">                            &lt;/sld:CssParameter&gt;</span>
<span class="s2">                        &lt;/sld:Stroke&gt;</span>
<span class="s2">                        &lt;/sld:Mark&gt;</span>
<span class="s2">                        &lt;sld:Size&gt;10&lt;/sld:Size&gt;</span>
<span class="s2">                    &lt;/sld:Graphic&gt;</span>
<span class="s2">                &lt;/sld:PointSymbolizer&gt;</span>
<span class="s2">            &lt;/sld:Rule&gt;</span>
<span class="s2">            &lt;/sld:FeatureTypeStyle&gt;</span>
<span class="s2">        &lt;/sld:UserStyle&gt;</span>
<span class="s2">    &lt;/sld:NamedLayer&gt;</span>
<span class="s2">    &lt;/sld:StyledLayerDescriptor&gt;&quot;&quot;&quot;</span>

        <span class="c1"># user without change_dataset_style cannot edit it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sld</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.ogc.sld+xml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>

        <span class="c1"># user with change_dataset_style can edit it</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sld</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.ogc.sld+xml&quot;</span><span class="p">)</span>
        <span class="c1"># _content_type = response.getheader(&#39;Content-Type&#39;)</span>
        <span class="c1"># self.assertEqual(_content_type, &#39;image/png&#39;)</span>

        <span class="c1"># Reset GeoFence Rules</span>
        <span class="n">delete_all_acl_rules</span><span class="p">()</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">rules_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_maplayers_default_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_maplayers_default_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_maplayers_default_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that Dataset.set_default_permissions is behaving as expected&quot;&quot;&quot;</span>

        <span class="c1"># Get a Dataset object to work with</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
        <span class="c1"># Set the default permissions</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>

        <span class="c1"># Test that the anonymous user can read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that the owner user can read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that the owner user can download it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that the owner user can edit metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that the owner user can edit data if is vector type</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;vector&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>

        <span class="c1"># Test that the owner user can edit styles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>

        <span class="c1"># Test that the owner can manage the layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span></div>


<div class="viewcode-block" id="SecurityTests.test_set_dataset_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_set_dataset_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_set_dataset_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the set_dataset_permissions view is behaving as expected&quot;&quot;&quot;</span>

        <span class="c1"># Get a layer to work with</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>

        <span class="c1"># FIXME Test a comprehensive set of permissions specifications</span>

        <span class="c1"># Set the Default Permissions</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>

        <span class="c1"># Test that the Permissions for anonymous user are set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Set the Permissions</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">)</span>

        <span class="c1"># Test that the Permissions for anonymous user are un-set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that previous permissions for users other than ones specified in</span>
        <span class="c1"># the perm_spec (and the layers owner) were removed</span>
        <span class="n">current_perms</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_perms</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Test that there are no duplicates on returned permissions</span>
        <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">current_perms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_kk</span><span class="p">,</span> <span class="n">_vv</span> <span class="ow">in</span> <span class="n">current_perms</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">_vv</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_vv</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">_vv_1</span> <span class="o">=</span> <span class="n">_vv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">_vv_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_vv</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
                    <span class="n">_vv_1</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">_vv_2</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">_vv_1</span><span class="p">,</span> <span class="n">_vv_2</span><span class="p">)</span>

        <span class="c1"># Test that the User permissions specified in the perm_spec were</span>
        <span class="c1"># applied properly</span>
        <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span></div>


<div class="viewcode-block" id="SecurityTests.test_ajax_dataset_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_ajax_dataset_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ajax_dataset_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the ajax_dataset_permissions view is behaving as expected&quot;&quot;&quot;</span>

        <span class="c1"># Setup some layer names to work with</span>
        <span class="n">valid_dataset_typename</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="n">invalid_dataset_id</span> <span class="o">=</span> <span class="mi">9999999</span>

        <span class="c1"># Test that an invalid layer.alternate is handled for properly</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;resource_permissions&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">invalid_dataset_id</span><span class="p">,)),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>

        <span class="c1"># Test that GET returns permissions</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;resource_permissions&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">valid_dataset_typename</span><span class="p">,)))</span>
        <span class="k">assert</span> <span class="s2">&quot;permissions&quot;</span> <span class="ow">in</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># Test that a user is required to have maps.change_dataset_permissions</span>

        <span class="c1"># First test un-authenticated</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;resource_permissions&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">valid_dataset_typename</span><span class="p">,)),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>

        <span class="c1"># Next Test with a user that does NOT have the proper perms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;norman&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;norman&quot;</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;resource_permissions&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">valid_dataset_typename</span><span class="p">,)),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>

        <span class="c1"># Login as a user with the proper permission and test the endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;resource_permissions&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">valid_dataset_typename</span><span class="p">,)),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perm_spec</span><span class="p">),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Test that the method returns 200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></div>


        <span class="c1"># Test that the permissions specification is applied</span>

        <span class="c1"># Should we do this here, or assume the tests in</span>
        <span class="c1"># test_set_dataset_permissions will handle for that?</span>

<div class="viewcode-block" id="SecurityTests.test_perms_info">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_perms_info">[docs]</a>
    <span class="k">def</span> <span class="nf">test_perms_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the perms_info view is behaving as expected&quot;&quot;&quot;</span>
        <span class="c1"># Test with a Dataset object</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>
        <span class="c1"># Test that the anonymous user can read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test that layer owner can edit layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="c1"># Test with a Map object</span>
        <span class="n">a_map</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">a_map</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">get_users_with_perms</span><span class="p">(</span><span class="n">a_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perms</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div>


    <span class="c1"># now we test permissions, first on an authenticated user and then on the</span>
    <span class="c1"># anonymous user</span>
    <span class="c1"># 1. view_resourcebase</span>
    <span class="c1"># 2. change_resourcebase</span>
    <span class="c1"># 3. delete_resourcebase</span>
    <span class="c1"># 4. change_resourcebase_metadata</span>
    <span class="c1"># 5. change_resourcebase_permissions</span>
    <span class="c1"># 6. change_dataset_data</span>
    <span class="c1"># 7. change_dataset_style</span>

<div class="viewcode-block" id="SecurityTests.test_not_superuser_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_not_superuser_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_not_superuser_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rules_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">delete_all_acl_rules</span><span class="p">()</span>
            <span class="c1"># Reset GeoFence Rules</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">rules_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># grab bobby</span>
        <span class="n">bob</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>

        <span class="c1"># grab a layer</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">bob</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>
        <span class="c1"># verify bobby has view permissions on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="c1"># Check GeoFence Rules have been correctly created</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">))</span>

        <span class="c1"># 1. view_resourcebase</span>
        <span class="c1"># 1.1 has view_resourcebase: verify that bobby can access the layer</span>
        <span class="c1"># detail page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_embed&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="c1"># 1.2 has not view_resourcebase: verify that bobby can not access the</span>
        <span class="c1"># layer detail page</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;anonymous&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_embed&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="c1"># 2. change_resourcebase</span>
        <span class="c1"># 2.1 has not change_resourcebase: verify that bobby cannot access the</span>
        <span class="c1"># layer replace page</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_replace&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="c1"># 2.2 has change_resourcebase: verify that bobby can access the layer</span>
        <span class="c1"># replace page</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_replace&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="c1"># 3. change_resourcebase_metadata</span>
        <span class="c1"># 3.1 has not change_resourcebase_metadata: verify that bobby cannot</span>
        <span class="c1"># access the layer metadata page</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="c1"># 3.2 has delete_resourcebase: verify that bobby can access the layer</span>
        <span class="c1"># delete page</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">]},</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">get_users_with_perms</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2. perms: </span><span class="si">{</span><span class="n">perms</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">create_geofence_rules</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">bob</span><span class="p">)</span>
            <span class="n">geofence</span><span class="o">.</span><span class="n">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="c1"># Check GeoFence Rules have been correctly created</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3. rules_count: </span><span class="si">{</span><span class="n">rules_count</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="c1"># 4. change_resourcebase_permissions</span>
        <span class="c1"># should be impossible for the user without change_resourcebase_permissions</span>
        <span class="c1"># to change permissions as the permission form is not available in the</span>
        <span class="c1"># layer detail page?</span>

        <span class="c1"># 5. change_dataset_data</span>
        <span class="c1"># must be done in integration test sending a WFS-T request with CURL</span>

        <span class="c1"># 6. change_dataset_style</span>
        <span class="c1"># 6.1 has not change_dataset_style: verify that bobby cannot access</span>
        <span class="c1"># the layer style page</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="c1"># Only for geoserver backend</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_style_manage&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="c1"># 7.2 has change_dataset_style: verify that bobby can access the</span>
        <span class="c1"># change layer style page</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="c1"># Only for geoserver backend</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_style_manage&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

        <span class="n">rules_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="n">delete_all_acl_rules</span><span class="p">()</span>
            <span class="c1"># Reset GeoFence Rules</span>
            <span class="n">rules_count</span> <span class="o">=</span> <span class="n">geofence</span><span class="o">.</span><span class="n">get_rules_count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rules_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rules_count</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_anonymus_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_anonymus_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_anonymus_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># grab a layer</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># removing duplicates</span>
        <span class="k">while</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_default_permissions</span><span class="p">()</span>
        <span class="c1"># 1. view_resourcebase</span>
        <span class="c1"># 1.1 has view_resourcebase: verify that anonymous user can access</span>
        <span class="c1"># the layer detail page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_embed&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="c1"># 1.2 has not view_resourcebase: verify that anonymous user can not</span>
        <span class="c1"># access the layer detail page</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_embed&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="mi">403</span><span class="p">))</span>

        <span class="c1"># 2. change_resourcebase</span>
        <span class="c1"># 2.1 has not change_resourcebase: verify that anonymous user cannot</span>
        <span class="c1"># access the layer replace page but redirected to login</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_replace&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="mi">403</span><span class="p">))</span>

        <span class="c1"># 3. change_resourcebase_metadata</span>
        <span class="c1"># 3.1 has not change_resourcebase_metadata: verify that anonymous user</span>
        <span class="c1"># cannot access the layer metadata page but redirected to login</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="mi">403</span><span class="p">))</span>

        <span class="c1"># 4. change_dataset_style</span>
        <span class="c1"># 4.1 has not change_dataset_style: verify that anonymous user cannot access</span>
        <span class="c1"># the layer style page but redirected to login</span>
        <span class="k">if</span> <span class="n">check_ogc_backend</span><span class="p">(</span><span class="n">geoserver</span><span class="o">.</span><span class="n">BACKEND_PACKAGE</span><span class="p">):</span>
            <span class="c1"># Only for geoserver backend</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_style_manage&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">alternate</span><span class="p">,)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">302</span><span class="p">,</span> <span class="mi">403</span><span class="p">))</span></div>


<div class="viewcode-block" id="SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_false">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_false">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources_should_return_resource_with_metadata_only_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">))</span></div>


<div class="viewcode-block" id="SecurityTests.test_get_visible_resources_should_return_updated_resource_with_metadata_only_false">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources_should_return_updated_resource_with_metadata_only_false">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources_should_return_updated_resource_with_metadata_only_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Updating the layer with metadata only True to verify that the filter works</span>
        <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;dataset metadata true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dirty_state</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">))</span></div>


<div class="viewcode-block" id="SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_true">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_true">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources_should_return_resource_with_metadata_only_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If metadata only is provided, it should return only the metadata resources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="s2">&quot;dataset_with_metadata_only_True&quot;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">metadata_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
                <span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">metadata_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>


<div class="viewcode-block" id="SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_none">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources_should_return_resource_with_metadata_only_none">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources_should_return_resource_with_metadata_only_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If metadata only is provided, it should return only the metadata resources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="s2">&quot;dataset_with_metadata_only_True&quot;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">metadata_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
                <span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">metadata_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">GROUP_PRIVATE_RESOURCES</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SecurityTests.test_get_visible_resources_advanced_workflow">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources_advanced_workflow">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources_advanced_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">admin_user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">standard_user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">standard_user</span><span class="p">)</span>
        <span class="n">admin_user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">admin_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">admin_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">standard_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c1"># Test &#39;is_approved=False&#39; &#39;is_published=False&#39;</span>
        <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">standard_user</span><span class="p">))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">admin_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">standard_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c1"># Test private groups</span>
        <span class="n">private_groups</span> <span class="o">=</span> <span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">access</span><span class="o">=</span><span class="s2">&quot;private&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_groups</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="n">private_groups</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">leave</span><span class="p">(</span><span class="n">standard_user</span><span class="p">)</span>
            <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">standard_user</span><span class="p">))</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">private_groups</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">admin_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">standard_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># The method returns only &#39;metadata_only=False&#39; resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">())</span></div>


<div class="viewcode-block" id="SecurityTests.test_get_visible_resources">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_get_visible_resources">[docs]</a>
    <span class="k">def</span> <span class="nf">test_get_visible_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">standard_user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># update user&#39;s perm on a layer,</span>
        <span class="c1"># this should not return the layer since it will not be in user&#39;s allowed resources</span>
        <span class="n">_title</span> <span class="o">=</span> <span class="s2">&quot;common bar&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">_title</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">standard_user</span><span class="p">,</span>
            <span class="n">admin_approval_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unpublished_not_visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">private_groups_not_visibile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">_title</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="c1"># get layers as admin, this should return all layers with metadata_only = True</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">get_visible_resources</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">_title</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span></div>


<div class="viewcode-block" id="SecurityTests.test_perm_spec_conversion">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_perm_spec_conversion">[docs]</a>
    <span class="k">def</span> <span class="nf">test_perm_spec_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perm Spec from extended to cmpact and viceversa</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">standard_user</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;bobby&quot;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">standard_user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="n">_p</span> <span class="o">=</span> <span class="n">PermSpec</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
            <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">]},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/7a68c67c8d409ff07e42aa5d5ab7b765/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;manage&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;organizations&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Registered Members&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="n">_p</span> <span class="o">=</span> <span class="n">PermSpec</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/7a68c67c8d409ff07e42aa5d5ab7b765/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;manage&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;organizations&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Registered Members&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">PermSpecCompact</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">))</span>
        <span class="n">_pp</span> <span class="o">=</span> <span class="n">PermSpecCompact</span><span class="p">(</span><span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="n">_pp_e</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;anonymous&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">__key</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">__key</span><span class="p">)))),</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">__key</span><span class="p">))))</span>
                <span class="p">)</span>

        <span class="n">_pp2</span> <span class="o">=</span> <span class="n">PermSpecCompact</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="n">dataset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">_pp2</span><span class="p">)</span>
        <span class="n">_pp_e</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;anonymous&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">__key</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">extended</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">__key</span><span class="p">)))),</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_pp_e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">__key</span><span class="p">))))</span>
                <span class="p">)</span>

        <span class="c1"># Test &quot;download&quot; permissions retention policy</span>
        <span class="c1"># 1. &quot;download&quot; permissions are allowed on &quot;Documents&quot;</span>
        <span class="n">test_document</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="n">_p</span> <span class="o">=</span> <span class="n">PermSpec</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">,</span> <span class="n">test_document</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">},</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;download&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/7a68c67c8d409ff07e42aa5d5ab7b765/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;organizations&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Registered Members&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># 2. &quot;download&quot; permissions are NOT allowed on &quot;Maps&quot;</span>
        <span class="n">test_map</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">perm_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="n">_p</span> <span class="o">=</span> <span class="n">PermSpec</span><span class="p">(</span><span class="n">perm_spec</span><span class="p">,</span> <span class="n">test_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;bobby&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">},</span>
            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">standard_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;avatar&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.gravatar.com/avatar/7a68c67c8d409ff07e42aa5d5ab7b765/?s=240&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;is_staff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;is_superuser&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;organizations&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;anonymous&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;registered-members&quot;</span><span class="p">,</span> <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Registered Members&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="n">_p</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_admin_whitelisted_access_backend">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_admin_whitelisted_access_backend">[docs]</a>
    <span class="k">def</span> <span class="nf">test_admin_whitelisted_access_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">geonode.security.backends</span> <span class="kn">import</span> <span class="n">AdminRestrictedAccessBackend</span>
        <span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>

        <span class="n">backend</span> <span class="o">=</span> <span class="n">AdminRestrictedAccessBackend</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;88.88.88.88&quot;</span><span class="p">]):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">PermissionDenied</span><span class="p">):</span>
                <span class="n">backend</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">HttpRequest</span><span class="p">(),</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityTests.test_admin_whitelisted_access_middleware">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityTests.test_admin_whitelisted_access_middleware">[docs]</a>
    <span class="k">def</span> <span class="nf">test_admin_whitelisted_access_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">geonode.security.middleware</span> <span class="kn">import</span> <span class="n">AdminAllowedMiddleware</span>

        <span class="n">get_response</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">middleware</span> <span class="o">=</span> <span class="n">AdminAllowedMiddleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">)</span>

        <span class="n">admin</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Test invalid IP</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;88.88.88.88&quot;</span><span class="p">]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">AnonymousUser</span><span class="p">())</span>

            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">basic_auth</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;admin:admin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Basic </span><span class="si">{</span><span class="n">basic_auth</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">))</span>

            <span class="n">token</span> <span class="o">=</span> <span class="n">create_auth_token</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>

        <span class="c1"># Test valid IP</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>

        <span class="c1"># Test range of whitelisted IPs</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;127.0.0.0/24&quot;</span><span class="p">]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>

        <span class="c1"># Test valid IP in second element</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">ADMIN_IP_WHITELIST</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;88.88.88.88&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]):</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">admin</span>
            <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SecurityRulesTests">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityRulesTests">[docs]</a>
<span class="k">class</span> <span class="nc">SecurityRulesTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test resources synchronization with Guardian and dirty states cleaning</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SecurityRulesTests.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityRulesTests.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="s2">&quot;test_dataset&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecurityRulesTests.test_sync_resources_with_guardian_delay_false">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityRulesTests.test_sync_resources_with_guardian_delay_false">[docs]</a>
    <span class="k">def</span> <span class="nf">test_sync_resources_with_guardian_delay_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">DELAYED_SECURITY_SIGNALS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ACL_SECURITY_ENABLED</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">delete_acl_rules_for_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>
            <span class="c1"># Set geofence (and so the dirty state)</span>
            <span class="n">allow_layer_to_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>
            <span class="c1"># Retrieve the same layer</span>
            <span class="n">dirty_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># Check dirty state (True)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">dirty_dataset</span><span class="o">.</span><span class="n">dirty_state</span><span class="p">)</span>
            <span class="c1"># Call sync resources</span>
            <span class="n">sync_resources_with_guardian</span><span class="p">()</span>
            <span class="n">clean_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># Check dirty state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">clean_dataset</span><span class="o">.</span><span class="n">dirty_state</span><span class="p">)</span></div>


    <span class="c1"># TODO: DELAYED SECURITY MUST BE REVISED</span>
<div class="viewcode-block" id="SecurityRulesTests.test_sync_resources_with_guardian_delay_true">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SecurityRulesTests.test_sync_resources_with_guardian_delay_true">[docs]</a>
    <span class="k">def</span> <span class="nf">test_sync_resources_with_guardian_delay_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">DELAYED_SECURITY_SIGNALS</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ACL_SECURITY_ENABLED</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">delete_acl_rules_for_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>
            <span class="c1"># Set geofence (and so the dirty state)</span>
            <span class="n">allow_layer_to_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>
            <span class="c1"># Retrieve the same layer</span>
            <span class="n">dirty_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># Check dirty state (True)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dirty_dataset</span><span class="o">.</span><span class="n">dirty_state</span><span class="p">)</span>
            <span class="c1"># Call sync resources</span>
            <span class="n">sync_resources_with_guardian</span><span class="p">()</span></div>
</div>

            <span class="c1"># clean_dataset = Dataset.objects.get(pk=self._l.id)</span>
            <span class="c1"># Check dirty state</span>
            <span class="c1"># TODO: DELAYED SECURITY MUST BE REVISED</span>
            <span class="c1"># self.assertFalse(clean_dataset.dirty_state)</span>


<div class="viewcode-block" id="TestGetUserGeolimits">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits">[docs]</a>
<span class="k">class</span> <span class="nc">TestGetUserGeolimits</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestGetUserGeolimits.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="s2">&quot;main-layer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gf_services</span> <span class="o">=</span> <span class="n">_get_gf_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perms</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestGetUserGeolimits.test_should_not_disable_cache_for_user_without_geolimits">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits.test_should_not_disable_cache_for_user_without_geolimits">[docs]</a>
    <span class="k">def</span> <span class="nf">test_should_not_disable_cache_for_user_without_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_disable_dataset_cache</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestGetUserGeolimits.test_should_disable_cache_for_user_with_geolimits">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits.test_should_disable_cache_for_user_with_geolimits">[docs]</a>
    <span class="k">def</span> <span class="nf">test_should_disable_cache_for_user_with_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">geo_limit</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">UserGeoLimit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">users_geolimits</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">geo_limit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_disable_dataset_cache</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestGetUserGeolimits.test_should_not_disable_cache_for_anonymous_without_geolimits">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits.test_should_not_disable_cache_for_anonymous_without_geolimits">[docs]</a>
    <span class="k">def</span> <span class="nf">test_should_not_disable_cache_for_anonymous_without_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_disable_dataset_cache</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestGetUserGeolimits.test_should_disable_cache_for_anonymous_with_geolimits">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestGetUserGeolimits.test_should_disable_cache_for_anonymous_with_geolimits">[docs]</a>
    <span class="k">def</span> <span class="nf">test_should_disable_cache_for_anonymous_with_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">geo_limit</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">UserGeoLimit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">get_anonymous_user</span><span class="p">(),</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">users_geolimits</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">geo_limit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="n">_disable_dataset_cache</span> <span class="o">=</span> <span class="n">has_geolimits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">_disable_dataset_cache</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SetPermissionsTestCase">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase">[docs]</a>
<span class="k">class</span> <span class="nc">SetPermissionsTestCase</span><span class="p">(</span><span class="n">GeoNodeBaseTestSupport</span><span class="p">):</span>
<div class="viewcode-block" id="SetPermissionsTestCase.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creating groups and asign also to the anonymous_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;group_manager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;group_member&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;not_group_member&quot;</span><span class="p">)</span>

        <span class="c1"># Defining group profiles and members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_profile</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="s2">&quot;custom_group&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_custom_group</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="s2">&quot;second_custom_group&quot;</span><span class="p">)</span>

        <span class="c1"># defining group members</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_profile</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_profile</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_profile</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">second_custom_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>

        <span class="c1"># Creating he default resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_layer&quot;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_profile</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span> <span class="o">=</span> <span class="n">get_anonymous_user</span><span class="p">()</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_set_compact_permissions">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_set_compact_permissions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_set_compact_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **AUTO PUBLISHING** - test_set_compact_permissions</span>
<span class="sd">          - `RESOURCE_PUBLISHING = False`</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">PermSpec</span><span class="p">({</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{}},</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="n">PermSpec</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span>
                        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;second_custom_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compact</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">use_cases</span><span class="p">):</span>
            <span class="n">permissions</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2"> - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_are_set_as_expected_resource_publishing_True">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_are_set_as_expected_resource_publishing_True">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_are_set_as_expected_resource_publishing_True</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **SIMPLE PUBLISHING** - test_permissions_are_set_as_expected_resource_publishing_True</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True` (Autopublishing is disabled)</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{}},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;second_custom_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]}},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">use_cases</span><span class="p">):</span>
            <span class="n">permissions</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2"> - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_are_set_as_expected_admin_upload_resource_publishing_True">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_are_set_as_expected_admin_upload_resource_publishing_True">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_are_set_as_expected_admin_upload_resource_publishing_True</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **ADVANCED WORKFLOW** - test_permissions_are_set_as_expected_admin_upload_resource_publishing_True</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True`</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = True`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{}},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;second_custom_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]}},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">use_cases</span><span class="p">):</span>
                <span class="n">permissions</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">item</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span>
                        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2"> - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_are_set_as_expected_admin_upload_resource_publishing_False">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_are_set_as_expected_admin_upload_resource_publishing_False">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_are_set_as_expected_admin_upload_resource_publishing_False</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **AUTO PUBLISHING** - test_permissions_are_set_as_expected_admin_upload_resource_publishing_False</span>
<span class="sd">          - `RESOURCE_PUBLISHING = False`</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{}},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AnonymousUser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]},</span>
                    <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;second_custom_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">]},</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">not_group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anonymous_user</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">use_cases</span><span class="p">):</span>
            <span class="n">permissions</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span>
                    <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2"> - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_on_user_role_promotion_to_manager">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_on_user_role_promotion_to_manager">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_on_user_role_promotion_to_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **ADVANCED WORKFLOW** - test_permissions_on_user_role_promotion_to_manager</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True`</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = True`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">group__title</span><span class="o">=</span><span class="s2">&quot;Registered Members&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;member&quot;</span><span class="p">)</span>
            <span class="n">sut</span><span class="o">.</span><span class="n">promote</span><span class="p">()</span>
            <span class="n">sut</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;manager&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #0 - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">sut</span><span class="o">.</span><span class="n">demote</span><span class="p">()</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_on_user_role_demote_to_member">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_on_user_role_demote_to_member">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_on_user_role_demote_to_member</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **ADVANCED WORKFLOW** - test_permissions_on_user_role_demote_to_member</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True`</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = True`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">group__title</span><span class="o">=</span><span class="s2">&quot;Registered Members&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">demote</span><span class="p">()</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #0 - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_on_user_role_demote_to_member_only_RESOURCE_PUBLISHING_active">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_on_user_role_demote_to_member_only_RESOURCE_PUBLISHING_active">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_on_user_role_demote_to_member_only_RESOURCE_PUBLISHING_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **SIMPLE PUBLISHING** - test_permissions_on_user_role_demote_to_member_only_RESOURCE_PUBLISHING_active</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True` (Autopublishing is disabled)</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">group__title</span><span class="o">=</span><span class="s2">&quot;Registered Members&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">demote</span><span class="p">()</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #0 - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="SetPermissionsTestCase.test_permissions_on_user_role_promote_to_manager_only_RESOURCE_PUBLISHING_active">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.SetPermissionsTestCase.test_permissions_on_user_role_promote_to_manager_only_RESOURCE_PUBLISHING_active">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_on_user_role_promote_to_manager_only_RESOURCE_PUBLISHING_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **SIMPLE PUBLISHING** - test_permissions_on_user_role_promote_to_manager_only_RESOURCE_PUBLISHING_active</span>
<span class="sd">          - `RESOURCE_PUBLISHING = True` (Autopublishing is disabled)</span>
<span class="sd">          - `ADMIN_MODERATE_UPLOADS = False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">group__title</span><span class="o">=</span><span class="s2">&quot;Registered Members&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">promote</span><span class="p">()</span>
        <span class="n">sut</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sut</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">,</span>
                <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">authorized_subject</span><span class="p">,</span> <span class="n">expected_perms</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">perms_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">()</span><span class="o">.</span><span class="n">get_user_perms</span><span class="p">(</span><span class="n">authorized_subject</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">expected_perms</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">perms_got</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;use case #0 - user: </span><span class="si">{</span><span class="n">authorized_subject</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>
</div>



<span class="nd">@override_settings</span><span class="p">(</span><span class="n">RESOURCE_PUBLISHING</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMIN_MODERATE_UPLOADS</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestPermissionChanges">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges">[docs]</a>
<span class="k">class</span> <span class="nc">TestPermissionChanges</span><span class="p">(</span><span class="n">GeoNodeBaseTestSupport</span><span class="p">):</span>
<div class="viewcode-block" id="TestPermissionChanges.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creating groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;group_manager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_group_manager</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;resource_group_manager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;group_member&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;member_with_perms&quot;</span><span class="p">)</span>

        <span class="c1"># Defining group profiles and members</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="s2">&quot;owner_group&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">GroupProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="s2">&quot;resource_group&quot;</span><span class="p">)</span>

        <span class="c1"># defining group members</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_member</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;member&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group_manager</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">)</span>

        <span class="c1"># Creating the default resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_layer_adv&quot;</span><span class="p">,</span>
            <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">was_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">was_published</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;download_resourcebase&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;change_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_resourcebase_metadata&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;change_dataset_style&quot;</span><span class="p">,</span> <span class="s2">&quot;change_dataset_data&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;delete_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;change_resourcebase_permissions&quot;</span><span class="p">,</span> <span class="s2">&quot;publish_resourcebase&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;download_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;view_resourcebase&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;resource-title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;resource-owner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;resource-date&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-10-27 05:59 am&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resource-date_type&quot;</span><span class="p">:</span> <span class="s2">&quot;publication&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resource-language&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="s2">&quot;resource-is_approved&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resource-group&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;dataset_attribute_set-TOTAL_FORMS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;dataset_attribute_set-INITIAL_FORMS&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">alternate</span><span class="p">,))</span>

        <span class="c1"># Assign manage perms to user member_with_perms</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_self_resource</span><span class="p">())</span>

        <span class="c1"># Assert inital assignment of permissions to groups and users</span>
        <span class="n">resource_perm_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestPermissionChanges.test_permissions_on_approve_and_publish_changes">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.test_permissions_on_approve_and_publish_changes">[docs]</a>
    <span class="k">def</span> <span class="nf">test_permissions_on_approve_and_publish_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Group manager approves a resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s2">&quot;group_manager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;group_manager&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;group_manager&quot;</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertions_for_approved_or_published_is_true</span><span class="p">()</span>

        <span class="c1"># Un approve resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resource-is_approved&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertions_for_approved_and_published_is_false</span><span class="p">()</span>

        <span class="c1"># Admin publishes and approves resource</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_approve_and_publish_resource</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertions_for_approved_or_published_is_true</span><span class="p">()</span>

        <span class="c1"># Admin Un approves and un publishes resource</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_unapprove_and_unpublish_resource</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertions_for_approved_and_published_is_false</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestPermissionChanges.test_owner_is_group_manager">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.test_owner_is_group_manager">[docs]</a>
    <span class="k">def</span> <span class="nf">test_owner_is_group_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">promote</span><span class="p">()</span>
            <span class="c1"># Admin publishes and approves the resource</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_approve_and_publish_resource</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="n">resource_perm_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>

            <span class="c1"># Once a resource has been published, the &#39;publish_resourcebase&#39; permission should be removed anyway</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">]),</span>
                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Admin un-approves and un-publishes the resource</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_unapprove_and_unpublish_resource</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="n">resource_perm_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">]),</span>
                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">GroupMember</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">demote</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestPermissionChanges.assertions_for_approved_or_published_is_true">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.assertions_for_approved_or_published_is_true">[docs]</a>
    <span class="k">def</span> <span class="nf">assertions_for_approved_or_published_is_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resource_perm_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestPermissionChanges.assertions_for_approved_and_published_is_false">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.assertions_for_approved_and_published_is_false">[docs]</a>
    <span class="k">def</span> <span class="nf">assertions_for_approved_and_published_is_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resource_perm_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">member_with_perms</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group_manager</span><span class="p">]),</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_perms</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_owner_limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">resource_perm_specs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_group</span><span class="o">.</span><span class="n">group</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_perms</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestPermissionChanges.admin_approve_and_publish_resource">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.admin_approve_and_publish_resource">[docs]</a>
    <span class="k">def</span> <span class="nf">admin_approve_and_publish_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resource-is_approved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resource-is_published&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="TestPermissionChanges.admin_unapprove_and_unpublish_resource">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestPermissionChanges.admin_unapprove_and_unpublish_resource">[docs]</a>
    <span class="k">def</span> <span class="nf">admin_unapprove_and_unpublish_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resource-is_approved&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;resource-is_published&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span></div>
</div>



<div class="viewcode-block" id="TestUserHasPerms">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms">[docs]</a>
<span class="k">class</span> <span class="nc">TestUserHasPerms</span><span class="p">(</span><span class="n">GeoNodeBaseTestSupport</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure that the Permission classes behaves as expected</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestUserHasPerms.setUpClass">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.setUpClass">[docs]</a>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">create_single_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_permission_dataset&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">create_single_doc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_permission_doc&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">create_single_map</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_permission_map&quot;</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestUserHasPerms.tearDownClass">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.tearDownClass">[docs]</a>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Dataset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_permission_dataset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;test_permission_doc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;test_permission_map&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestUserHasPerms.setUp">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;marty&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;mcfly&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestUserHasPerms.test_user_with_view_perms">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.test_user_with_view_perms">[docs]</a>
    <span class="k">def</span> <span class="nf">test_user_with_view_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;base-resources-detail&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;datasets-detail&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;documents-detail&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;maps-detail&quot;</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">_case</span> <span class="ow">in</span> <span class="n">use_cases</span><span class="p">:</span>
            <span class="c1"># setting the view permissions</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">_case</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">_case</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>

            <span class="n">_case</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="o">.</span><span class="n">username</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;base.view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;base.download_resourcebase&quot;</span><span class="p">]}}</span>
            <span class="p">)</span>
            <span class="c1"># calling the api</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># checking that the user can call the url in get</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">_case</span><span class="p">)</span>

            <span class="c1"># the user cannot patch the resource</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># checking that the user cannot call the url in patch due the lack of permissions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">_case</span><span class="p">)</span>

            <span class="c1"># after update the permissions list, the user can modify the resource</span>
            <span class="n">_case</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="o">.</span><span class="n">username</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;base.view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;base.change_resourcebase&quot;</span><span class="p">]}}</span>
            <span class="p">)</span>
            <span class="c1"># the user can patch the resource</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># checking that the user can call the url in patch since now it has the permissions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">_case</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestUserHasPerms.test_user_with_view_listing">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.test_user_with_view_listing">[docs]</a>
    <span class="k">def</span> <span class="nf">test_user_with_view_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">use_cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;base-resources-list&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;datasets-list&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;documents-list&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;maps-list&quot;</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">_case</span> <span class="ow">in</span> <span class="n">use_cases</span><span class="p">:</span>
            <span class="c1"># setting the view permissions</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">_case</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>

            <span class="n">_case</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_permissions</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="o">.</span><span class="n">username</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;base.view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;base.download_resourcebase&quot;</span><span class="p">]}}</span>
            <span class="p">)</span>
            <span class="c1"># calling the api</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marty</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># checking that the user can call the url in get</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">_case</span><span class="p">)</span>

            <span class="c1"># the user cannot patch the resource</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># checking that the user cannot call the url in patch due the lack of permissions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">_case</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestUserHasPerms.test_anonymous_user_is_stripped_off">
<a class="viewcode-back" href="../../../autoapi/geonode/security/tests/index.html#geonode.security.tests.TestUserHasPerms.test_anonymous_user_is_stripped_off">[docs]</a>
    <span class="k">def</span> <span class="nf">test_anonymous_user_is_stripped_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">geonode.base.models</span> <span class="kn">import</span> <span class="n">ResourceBase</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base.view_resourcebase&quot;</span><span class="p">,</span> <span class="s2">&quot;base.download_resourcebase&quot;</span><span class="p">]</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">ResourceBase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">get_anonymous_user</span><span class="p">(),</span> <span class="n">resource</span><span class="p">)</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;anonymous&quot;</span><span class="p">),</span> <span class="n">resource</span><span class="p">)</span>

        <span class="n">perm_spec</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get_all_level_info</span><span class="p">()</span>
        <span class="n">anonymous_user_perm</span> <span class="o">=</span> <span class="n">perm_spec</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_anonymous_user</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">anonymous_user_perm</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Anynmous user wasn&#39;t removed&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kan Territory &amp; IT.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>